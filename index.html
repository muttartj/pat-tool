<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegraph Pattern Tooling</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif; }
    @keyframes slide-in {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .animate-slide-in { animation: slide-in 0.3s ease-out; }
  </style>
  <script>
    // Set PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useMemo, useCallback, useEffect } = React;

    // Icons
    const Icons = {
      Database: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>,
      ChevronDown: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m6 9 6 6 6-6"/></svg>,
      ChevronRight: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m9 18 6-6-6-6"/></svg>,
      BarChart3: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
      ArrowRightLeft: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></svg>,
      Layers: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg>,
      FileText: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>,
      ClipboardList: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>,
      User: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
      Upload: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
      Download: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
      FileSpreadsheet: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 13h2"/><path d="M14 13h2"/><path d="M8 17h2"/><path d="M14 17h2"/></svg>,
      Image: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
      Check: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M20 6 9 17l-5-5"/></svg>,
      AlertTriangle: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
      ArrowUpDown: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m21 16-4 4-4-4"/><path d="M17 20V4"/><path d="m3 8 4-4 4 4"/><path d="M7 4v16"/></svg>,
      Search: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
      ExternalLink: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>,
      Zap: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"/></svg>,
      Globe: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>,
      Truck: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M15 18H9"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"/><circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/></svg>,
      Package: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>,
      AlertCircle: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
      Rocket: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>,
      FolderOpen: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2"/></svg>,
      Plus: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
      Trash2: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
      Play: ({size=24,...p}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polygon points="6 3 20 12 6 21 6 3"/></svg>,
    };

    // Template columns - Full list from Pattern Collection Template
    const TEMPLATE_COLUMNS = [
      'telegraph_pattern_name','stcc','origin_city','origin_state','origin_country',
      'destination_city','destination_state','destination_country','route','shipment_type','bill_type','payment_type',
      'shipper_name','shipper_address','shipper_city','shipper_state','shipper_postal','shipper_country',
      'consignee_name','consignee_address','consignee_city','consignee_state','consignee_postal','consignee_country',
      'freight_payor_name','freight_payor_address','freight_payor_city','freight_payor_state','freight_payor_postal','freight_payor_country',
      'rule11_name','rule11_address','rule11_city','rule11_state','rule11_postal','rule11_country',
      'careof_name','careof_address','careof_city','careof_state','careof_postal','careof_country',
      'can_broker_name','can_broker_address','can_broker_city','can_broker_state','can_broker_postal','can_broker_country',
      'importer_address','importer_city','importer_state','importer_postal','importer_country',
      'mx_broker_name','mx_broker_address','mx_broker_city','mx_broker_state','mx_broker_postal','mx_broker_country',
      'mx_unc','mx_mmt','mx_mtc','mx_mpc','mx_taxpayer_id',
      'temp_control_needed','empty_disposition_needed',
      'price_authority_type','price_authority_reference_id','price_authority_tariff_agency','price_authority_carrier'
    ];
    
    const COLUMN_LABELS = {
      'telegraph_pattern_name':'Pattern Name','stcc':'STCC','origin_city':'Origin City','origin_state':'Origin State','origin_country':'Origin Country',
      'destination_city':'Dest City','destination_state':'Dest State','destination_country':'Dest Country','route':'Route',
      'shipment_type':'Shipment Type','bill_type':'Bill Type','payment_type':'Payment Type',
      'shipper_name':'Shipper Name','shipper_address':'Shipper Address','shipper_city':'Shipper City','shipper_state':'Shipper State','shipper_postal':'Shipper Postal','shipper_country':'Shipper Country',
      'consignee_name':'Consignee Name','consignee_address':'Consignee Address','consignee_city':'Consignee City','consignee_state':'Consignee State','consignee_postal':'Consignee Postal','consignee_country':'Consignee Country',
      'freight_payor_name':'Freight Payor','freight_payor_address':'FP Address','freight_payor_city':'FP City','freight_payor_state':'FP State','freight_payor_postal':'FP Postal','freight_payor_country':'FP Country',
      'rule11_name':'Rule 11 Name','rule11_address':'R11 Address','rule11_city':'R11 City','rule11_state':'R11 State','rule11_postal':'R11 Postal','rule11_country':'R11 Country',
      'careof_name':'Care Of Party','careof_address':'Care Of Address','careof_city':'Care Of City','careof_state':'Care Of State','careof_postal':'Care Of Postal','careof_country':'Care Of Country',
      'can_broker_name':'CAN Broker','can_broker_address':'CAN Broker Address','can_broker_city':'CAN Broker City','can_broker_state':'CAN Broker State','can_broker_postal':'CAN Broker Postal','can_broker_country':'CAN Broker Country',
      'importer_address':'Importer Address','importer_city':'Importer City','importer_state':'Importer State','importer_postal':'Importer Postal','importer_country':'Importer Country',
      'mx_broker_name':'MX Broker','mx_broker_address':'MX Broker Address','mx_broker_city':'MX Broker City','mx_broker_state':'MX Broker State','mx_broker_postal':'MX Broker Postal','mx_broker_country':'MX Broker Country',
      'mx_unc':'MX UNC','mx_mmt':'MX MMT','mx_mtc':'MX MTC','mx_mpc':'MX MPC','mx_taxpayer_id':'MX Tax Payer ID',
      'temp_control_needed':'Temp Control Needed','empty_disposition_needed':'Empty Disposition Needed',
      'price_authority_type':'Price Auth Type','price_authority_reference_id':'Price Auth Ref ID','price_authority_tariff_agency':'Price Auth Tariff Agency','price_authority_carrier':'Price Auth Carrier'
    };

    // Smarter column matching - handles camelCase, PascalCase, snake_case, and various formats
    const normalizeForMatching = (str) => {
      return str
        .replace(/([a-z])([A-Z])/g, '$1 $2') // camelCase/PascalCase to spaces
        .replace(/[_-]/g, ' ') // snake_case/kebab-case to spaces
        .replace(/[^a-zA-Z0-9\s]/g, '') // remove special chars
        .toLowerCase()
        .replace(/\s+/g, ' ')
        .trim();
    };

    // Direct mapping from normalized source names to template columns
    const DIRECT_MAPPINGS = {
      // Pattern info
      'telegraph pattern name': 'telegraph_pattern_name',
      'telegraph pattern names': 'telegraph_pattern_name',
      'pattern name': 'telegraph_pattern_name',
      'pattern': 'telegraph_pattern_name',
      'stcc': 'stcc',
      'stcc code': 'stcc',
      'commodity code': 'stcc',
      
      // Origin
      'origin city': 'origin_city',
      'origincity': 'origin_city',
      'orig city': 'origin_city',
      'origin state': 'origin_state',
      'originstate': 'origin_state',
      'orig state': 'origin_state',
      'origin country': 'origin_country',
      'origincountry': 'origin_country',
      'orig country': 'origin_country',
      
      // Destination
      'destination city': 'destination_city',
      'destinationcity': 'destination_city',
      'dest city': 'destination_city',
      'destination state': 'destination_state',
      'destinationstate': 'destination_state',
      'dest state': 'destination_state',
      'destination country': 'destination_country',
      'destinationcountry': 'destination_country',
      'dest country': 'destination_country',
      
      // Route & Shipment
      'route': 'route',
      'routing': 'route',
      'carrier': 'route',
      'shipment type': 'shipment_type',
      'shipmenttype': 'shipment_type',
      'bill type': 'bill_type',
      'billtype': 'bill_type',
      'payment type': 'payment_type',
      'paymenttype': 'payment_type',
      'payment terms': 'payment_type',
      
      // Shipper
      'shipper name': 'shipper_name',
      'shippername': 'shipper_name',
      'shipper': 'shipper_name',
      'shipper address': 'shipper_address',
      'shipperaddress': 'shipper_address',
      'shipper address1': 'shipper_address',
      'shipper city': 'shipper_city',
      'shippercity': 'shipper_city',
      'shipper state': 'shipper_state',
      'shipperstate': 'shipper_state',
      'shipper postal': 'shipper_postal',
      'shipperpostal': 'shipper_postal',
      'shipper zip': 'shipper_postal',
      'shipperzip': 'shipper_postal',
      'shipper country': 'shipper_country',
      'shippercountry': 'shipper_country',
      
      // Consignee
      'consignee name': 'consignee_name',
      'consigneename': 'consignee_name',
      'consignee': 'consignee_name',
      'consignee address': 'consignee_address',
      'consigneeaddress': 'consignee_address',
      'consignee address1': 'consignee_address',
      'consignee city': 'consignee_city',
      'consigneecity': 'consignee_city',
      'consignee state': 'consignee_state',
      'consigneestate': 'consignee_state',
      'consignee postal': 'consignee_postal',
      'consigneepostal': 'consignee_postal',
      'consignee zip': 'consignee_postal',
      'consigneezip': 'consignee_postal',
      'consignee country': 'consignee_country',
      'consigneecountry': 'consignee_country',
      
      // Freight Payor
      'freight payor name': 'freight_payor_name',
      'freightpayorname': 'freight_payor_name',
      'freight payor party': 'freight_payor_name',
      'freightpayorparty': 'freight_payor_name',
      'freight payor': 'freight_payor_name',
      'freightpayor': 'freight_payor_name',
      'payor name': 'freight_payor_name',
      'freight payor address': 'freight_payor_address',
      'freightpayoraddress': 'freight_payor_address',
      'payor address': 'freight_payor_address',
      'freight payor city': 'freight_payor_city',
      'freightpayorcity': 'freight_payor_city',
      'payor city': 'freight_payor_city',
      'freight payor state': 'freight_payor_state',
      'freightpayorstate': 'freight_payor_state',
      'payor state': 'freight_payor_state',
      'freight payor postal': 'freight_payor_postal',
      'freightpayorpostal': 'freight_payor_postal',
      'payor postal': 'freight_payor_postal',
      'payor zip': 'freight_payor_postal',
      'freight payor country': 'freight_payor_country',
      'freightpayorcountry': 'freight_payor_country',
      'payor country': 'freight_payor_country',
      
      // Rule 11
      'rule 11 name': 'rule11_name',
      'rule11 name': 'rule11_name',
      'rule11name': 'rule11_name',
      'rule 11 party': 'rule11_name',
      'rule11 party': 'rule11_name',
      'rule 11 address': 'rule11_address',
      'rule11 address': 'rule11_address',
      'rule11address': 'rule11_address',
      'rule 11 city': 'rule11_city',
      'rule11 city': 'rule11_city',
      'rule11city': 'rule11_city',
      'rule 11 state': 'rule11_state',
      'rule11 state': 'rule11_state',
      'rule11state': 'rule11_state',
      'rule 11 postal': 'rule11_postal',
      'rule11 postal': 'rule11_postal',
      'rule11postal': 'rule11_postal',
      'rule 11 country': 'rule11_country',
      'rule11 country': 'rule11_country',
      'rule11country': 'rule11_country',
      
      // Care Of
      'care of party': 'careof_name',
      'careof party': 'careof_name',
      'careofparty': 'careof_name',
      'care of name': 'careof_name',
      'careof name': 'careof_name',
      'careofname': 'careof_name',
      'care of address': 'careof_address',
      'careof address': 'careof_address',
      'careofaddress': 'careof_address',
      'care of city': 'careof_city',
      'careof city': 'careof_city',
      'careofcity': 'careof_city',
      'care of state': 'careof_state',
      'careof state': 'careof_state',
      'careofstate': 'careof_state',
      'care of postal': 'careof_postal',
      'careof postal': 'careof_postal',
      'careofpostal': 'careof_postal',
      'care of country': 'careof_country',
      'careof country': 'careof_country',
      'careofcountry': 'careof_country',
      
      // CAN Broker
      'can broker': 'can_broker_name',
      'canbroker': 'can_broker_name',
      'can broker name': 'can_broker_name',
      'canbrokername': 'can_broker_name',
      'can broker address': 'can_broker_address',
      'canbrokeraddress': 'can_broker_address',
      'can broker city': 'can_broker_city',
      'canbrokercity': 'can_broker_city',
      'can broker state': 'can_broker_state',
      'canbrokerstate': 'can_broker_state',
      'can broker postal': 'can_broker_postal',
      'canbrokerpostal': 'can_broker_postal',
      'can broker country': 'can_broker_country',
      'canbrokercountry': 'can_broker_country',
      
      // Importer
      'importer address': 'importer_address',
      'importeraddress': 'importer_address',
      'importer city': 'importer_city',
      'importercity': 'importer_city',
      'importer state': 'importer_state',
      'importerstate': 'importer_state',
      'importer postal': 'importer_postal',
      'importerpostal': 'importer_postal',
      'importer country': 'importer_country',
      'importercountry': 'importer_country',
      
      // MX Broker
      'mx broker': 'mx_broker_name',
      'mxbroker': 'mx_broker_name',
      'mx broker name': 'mx_broker_name',
      'mxbrokername': 'mx_broker_name',
      'mx broker address': 'mx_broker_address',
      'mxbrokeraddress': 'mx_broker_address',
      'mx broker city': 'mx_broker_city',
      'mxbrokercity': 'mx_broker_city',
      'mx broker state': 'mx_broker_state',
      'mxbrokerstate': 'mx_broker_state',
      'mx broker postal': 'mx_broker_postal',
      'mxbrokerpostal': 'mx_broker_postal',
      'mx broker country': 'mx_broker_country',
      'mxbrokercountry': 'mx_broker_country',
      
      // MX specific
      'mx unc': 'mx_unc',
      'mxunc': 'mx_unc',
      'mx mmt': 'mx_mmt',
      'mxmmt': 'mx_mmt',
      'mx mtc': 'mx_mtc',
      'mxmtc': 'mx_mtc',
      'mx mpc': 'mx_mpc',
      'mxmpc': 'mx_mpc',
      'mx taxpayer id': 'mx_taxpayer_id',
      'mxtaxpayerid': 'mx_taxpayer_id',
      'mx tax payer id': 'mx_taxpayer_id',
      
      // Other
      'temp control needed': 'temp_control_needed',
      'tempcontrolneeded': 'temp_control_needed',
      'temperature control': 'temp_control_needed',
      'empty disposition needed': 'empty_disposition_needed',
      'emptydispositionneeded': 'empty_disposition_needed',
      'price authority type': 'price_authority_type',
      'priceauthoritytype': 'price_authority_type',
      'price authority reference id': 'price_authority_reference_id',
      'priceauthorityreferenceid': 'price_authority_reference_id',
      'price authority tariff agency': 'price_authority_tariff_agency',
      'priceauthoritytariffagency': 'price_authority_tariff_agency',
      'price authority carrier': 'price_authority_carrier',
      'priceauthoritycarrier': 'price_authority_carrier',
    };

    const fuzzyMatchColumn = (sourceHeader) => {
      // Step 1: Normalize the source header
      const normalized = normalizeForMatching(sourceHeader);
      const normalizedNoSpaces = normalized.replace(/\s+/g, '');
      
      // Step 2: Try direct match first (highest confidence)
      if (DIRECT_MAPPINGS[normalized]) {
        return { target: DIRECT_MAPPINGS[normalized], confidence: 1 };
      }
      if (DIRECT_MAPPINGS[normalizedNoSpaces]) {
        return { target: DIRECT_MAPPINGS[normalizedNoSpaces], confidence: 1 };
      }
      
      // Step 3: Try matching against template column names directly
      // e.g., "shipper_address" should match shipper_address
      const snakeCased = normalized.replace(/\s+/g, '_');
      if (TEMPLATE_COLUMNS.includes(snakeCased)) {
        return { target: snakeCased, confidence: 1 };
      }
      
      // Step 4: Smarter partial matching - look for key terms in order
      // This handles cases like "ShipperAddressLine1" -> shipper_address
      const words = normalized.split(' ').filter(w => w.length > 0);
      
      for (const templateCol of TEMPLATE_COLUMNS) {
        const templateNormalized = templateCol.replace(/_/g, ' ');
        const templateWords = templateNormalized.split(' ');
        
        // Check if all template words appear in the source in the same order
        let matchIndex = 0;
        let allFound = true;
        for (const tw of templateWords) {
          const foundAt = words.findIndex((w, i) => i >= matchIndex && w.includes(tw) || tw.includes(w));
          if (foundAt >= matchIndex) {
            matchIndex = foundAt + 1;
          } else {
            allFound = false;
            break;
          }
        }
        
        if (allFound && templateWords.length > 0) {
          // Higher confidence if word count matches closely
          const confidence = templateWords.length === words.length ? 0.95 : 0.8;
          return { target: templateCol, confidence };
        }
      }
      
      // Step 5: Check if source contains template column as substring
      for (const templateCol of TEMPLATE_COLUMNS) {
        const templateNormalized = templateCol.replace(/_/g, '');
        if (normalizedNoSpaces.includes(templateNormalized) || templateNormalized.includes(normalizedNoSpaces)) {
          if (normalizedNoSpaces.length >= 4) { // Avoid matching tiny strings
            return { target: templateCol, confidence: 0.7 };
          }
        }
      }
      
      return null;
    };

    const US_STATE_ABBRS = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'];
    const CA_PROVINCES = ['AB','BC','MB','NB','NL','NS','NT','NU','ON','PE','QC','SK','YT'];

    const parseLocation = (text) => {
      if (!text) return null;
      const c = text.toString().trim().toUpperCase();
      const m = c.match(/^([A-Z\s]+?),?\s+([A-Z]{2,3})(?:,?\s+(US|USA|CA|CAN|MX|MEX))?$/);
      if (m) {
        let country = m[3] || '';
        if (US_STATE_ABBRS.includes(m[2])) country = 'US';
        else if (CA_PROVINCES.includes(m[2])) country = 'CA';
        if (country === 'USA') country = 'US';
        if (country === 'CAN') country = 'CA';
        if (country === 'MEX') country = 'MX';
        return { city: m[1].trim(), state: m[2], country: country || 'US' };
      }
      return null;
    };

    const exportToCSV = (data, filename) => {
      const h = TEMPLATE_COLUMNS.map(c => COLUMN_LABELS[c] || c);
      const rows = data.map(r => TEMPLATE_COLUMNS.map(c => `"${(r[c]||'').toString().replace(/"/g,'""')}"`).join(','));
      const blob = new Blob([[h.join(','), ...rows].join('\n')], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    };

    const exportToExcel = (data, filename) => {
      const h = TEMPLATE_COLUMNS.map(c => COLUMN_LABELS[c] || c);
      const rows = data.map(r => TEMPLATE_COLUMNS.map(c => r[c] || ''));
      const ws = XLSX.utils.aoa_to_sheet([h, ...rows]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Patterns');
      XLSX.writeFile(wb, filename);
    };

    const STORAGE_KEY = 'telegraph_projects';
    const API_KEY_STORAGE = 'telegraph_api_key';
    const loadProjects = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { return []; } };
    const saveProjects = p => localStorage.setItem(STORAGE_KEY, JSON.stringify(p));
    
    // API Key is stored but never displayed back to user
    const hasApiKey = () => !!localStorage.getItem(API_KEY_STORAGE);
    const saveApiKey = k => localStorage.setItem(API_KEY_STORAGE, k);
    const getApiKey = () => localStorage.getItem(API_KEY_STORAGE) || '';
    const clearApiKey = () => localStorage.removeItem(API_KEY_STORAGE);

    // Image/PDF Extraction via Claude API
    const extractPatternFromImage = async (base64Image, mediaType, apiKey) => {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 8192,
          messages: [{
            role: 'user',
            content: [
              { type: 'image', source: { type: 'base64', media_type: mediaType, data: base64Image }},
              { type: 'text', text: `You are extracting shipping pattern or rail waybill data from this image. Extract ALL visible information into a structured format.

Return ONLY a valid JSON array (no markdown code fences, no explanation) with objects containing these fields. Extract every field you can find - use empty string "" for fields not visible:

LANE INFORMATION:
- telegraph_pattern_name: Pattern identifier or generate from "STCC - OriginCity - DestCity"
- stcc: Commodity/STCC code (usually 7 digits)
- origin_city, origin_state, origin_country: Origin location (parse "FREEPORT TX"  Ã¢Â†Â’  "FREEPORT", "TX", "US")
- destination_city, destination_state, destination_country: Destination location
- route: Carrier routing codes (e.g., "BNSF-UP", "CN", "NS-CSX")

SHIPMENT DETAILS:
- shipment_type: Type of shipment (B=single, M=multi, etc.)
- bill_type: Billing type (S=single, M=multi, etc.)
- payment_type: Payment terms - IMPORTANT: Look for "PP" (Prepaid), "CC" (Collect), "11" (Rule 11), "Rule 11", "Prepaid", "Collect", etc.

SHIPPER PARTY (who is shipping):
- shipper_name: Shipper company name
- shipper_address: Street address line 1
- shipper_city: City
- shipper_state: State/Province (2-letter code)
- shipper_postal: ZIP/Postal code
- shipper_country: Country (US, CA, MX)

CONSIGNEE PARTY (who receives):
- consignee_name: Consignee company name
- consignee_address: Street address
- consignee_city: City
- consignee_state: State/Province
- consignee_postal: ZIP/Postal code
- consignee_country: Country

FREIGHT PAYOR PARTY (who pays - if different from shipper):
- freight_payor_name: Payor company name
- freight_payor_address: Street address
- freight_payor_city: City
- freight_payor_state: State/Province
- freight_payor_postal: ZIP/Postal code
- freight_payor_country: Country

RULE 11 PARTY (if payment_type includes "11"):
- rule11_name: Rule 11 party name
- rule11_address: Street address
- rule11_city: City
- rule11_state: State/Province
- rule11_postal: ZIP/Postal code
- rule11_country: Country

CARE OF PARTY (C/O, if present):
- careof_name: Care of party name
- careof_address: Street address
- careof_city: City
- careof_state: State/Province
- careof_postal: ZIP/Postal code
- careof_country: Country

BROKER PARTIES (for cross-border):
- can_broker_name, can_broker_address, can_broker_city, can_broker_state, can_broker_postal, can_broker_country
- mx_broker_name, mx_broker_address, mx_broker_city, mx_broker_state, mx_broker_postal, mx_broker_country
- importer_address, importer_city, importer_state, importer_postal, importer_country

MEXICO SPECIFIC:
- mx_unc, mx_mmt, mx_mtc, mx_mpc, mx_taxpayer_id

OTHER:
- temp_control_needed: "Y" or "N" or ""
- empty_disposition_needed: "Y" or "N" or ""
- price_authority_type, price_authority_reference_id, price_authority_tariff_agency, price_authority_carrier

IMPORTANT RULES:
1. Parse combined addresses: "123 MAIN ST, HOUSTON TX 77001"  Ã¢Â†Â’  address="123 MAIN ST", city="HOUSTON", state="TX", postal="77001"
2. For US states, use 2-letter abbreviations
3. Default country to "US" if clearly North American and not obviously CA or MX
4. Look carefully for payment terms - they may be abbreviated (PP, CC, 11, COL, PRE)
5. If multiple patterns/rows visible, return multiple objects in the array
6. Include ALL address fields you can find for each party

Return the JSON array now:`
              }
            ]
          }]
        })
      });
      
      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.error?.message || 'API request failed');
      }
      
      const data = await response.json();
      const text = data.content[0].text;
      
      // Parse JSON from response (handle potential markdown wrapping)
      let jsonStr = text.trim();
      if (jsonStr.startsWith('```')) {
        jsonStr = jsonStr.replace(/```json?\n?/g, '').replace(/```$/g, '').trim();
      }
      
      return JSON.parse(jsonStr);
    };

    const pdfToImages = async (file) => {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      const images = [];
      
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const scale = 2; // Higher quality
        const viewport = page.getViewport({ scale });
        
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const ctx = canvas.getContext('2d');
        
        await page.render({ canvasContext: ctx, viewport }).promise;
        
        // Convert to base64 (remove data:image/png;base64, prefix)
        const base64 = canvas.toDataURL('image/png').split(',')[1];
        images.push({ page: i, base64, mediaType: 'image/png' });
      }
      
      return images;
    };

    const fileToBase64 = (file) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    };

    // Analysis
    const analyzeData = (data) => {
      const rows = data.map((r, i) => {
        const tags = [];
        const stcc = (r.stcc || '').toString();
        const pt = (r.payment_type || '').toLowerCase();
        const oc = (r.origin_country || '').toUpperCase();
        const dc = (r.destination_country || '').toUpperCase();
        if (stcc.startsWith('48') || stcc.startsWith('49')) tags.push('HazMat');
        if (pt.includes('11')) tags.push('Rule 11');
        const involvesMXTag = oc === 'MX' || dc === 'MX';
        if (involvesMXTag) {
          tags.push('Carta Porte');
          if (oc && dc && oc !== dc) tags.push('Cross Border');
        } else if (oc && dc && oc !== dc) {
          tags.push('Cross Border');
        } else if (oc && dc) {
          tags.push('Domestic');
        }
        if (pt.includes('pp') || pt.includes('prepaid')) tags.push('Prepaid');
        return { ...r, _tags: tags, _index: i };
      });

      const calcUnique = (fields) => {
        const keys = new Set(rows.map(r => fields.map(f => (r[f] || '').toString().toLowerCase()).join('|')));
        return rows.length ? (keys.size / rows.length) * 100 : 0;
      };

      const pmkLevels = [
        { level: 1, displayFields: 'OriginCity + DestinationCity', fields: ['origin_city', 'destination_city'] },
        { level: 2, displayFields: 'OriginCity + DestinationCity + STCC', fields: ['origin_city', 'destination_city', 'stcc'] },
        { level: 3, displayFields: 'OriginCity + DestCity + STCC + ShipperAddress1', fields: ['origin_city', 'destination_city', 'stcc', 'shipper_address'] },
        { level: 4, displayFields: 'OriginCity + DestCity + STCC + ShipperAddress1 + ConsigneeAddress1', fields: ['origin_city', 'destination_city', 'stcc', 'shipper_address', 'consignee_address'] },
      ].map(l => ({ ...l, uniqueness: calcUnique(l.fields) }));

      // Find best additional field if 100% not achieved
      let suggestedField = null;
      let atRiskPatterns = [];
      const lastLevel = pmkLevels[pmkLevels.length - 1];
      
      if (lastLevel.uniqueness < 100) {
        // Find duplicate patterns (patterns with same PMK key)
        const pmkKeys = {};
        rows.forEach(r => {
          const key = lastLevel.fields.map(f => (r[f] || '').toString().toLowerCase()).join('|');
          if (!pmkKeys[key]) pmkKeys[key] = [];
          pmkKeys[key].push(r);
        });
        
        // Get patterns that have duplicates
        atRiskPatterns = Object.entries(pmkKeys)
          .filter(([key, patterns]) => patterns.length > 1)
          .map(([key, patterns]) => ({
            key,
            count: patterns.length,
            patterns: patterns.map(p => ({
              name: p.telegraph_pattern_name || `${p.stcc || ''} - ${p.origin_city || ''} to ${p.destination_city || ''}`,
              index: p._index,
              shipper: p.shipper_name,
              consignee: p.consignee_name,
              row: p
            }))
          }))
          .sort((a, b) => b.count - a.count);

        // Test ALL template columns as candidates (except the ones already in PMK levels)
        const candidateFields = TEMPLATE_COLUMNS
          .filter(key => !lastLevel.fields.includes(key))
          .map(key => ({ key, label: COLUMN_LABELS[key] || key }));
        
        let bestField = null;
        let bestUniqueness = lastLevel.uniqueness;
        
        // Track all fields that improve uniqueness
        const improvingFields = [];
        
        for (const candidate of candidateFields) {
          if (!lastLevel.fields.includes(candidate.key)) {
            const testFields = [...lastLevel.fields, candidate.key];
            const testUniqueness = calcUnique(testFields);
            if (testUniqueness > lastLevel.uniqueness) {
              improvingFields.push({ ...candidate, uniqueness: testUniqueness });
              if (testUniqueness > bestUniqueness) {
                bestUniqueness = testUniqueness;
                bestField = { ...candidate, uniqueness: testUniqueness };
              }
            }
          }
        }
        
        // If no single field helps, analyze what differs between duplicates
        let differingFields = [];
        if (!bestField && atRiskPatterns.length > 0) {
          // Check which fields differ between duplicates
          const fieldsToCheck = TEMPLATE_COLUMNS.filter(f => !lastLevel.fields.includes(f));
          const fieldDiffCounts = {};
          
          atRiskPatterns.forEach(group => {
            fieldsToCheck.forEach(field => {
              const values = group.patterns.map(p => (p.row[field] || '').toString().toLowerCase().trim());
              const uniqueValues = new Set(values.filter(v => v));
              if (uniqueValues.size > 1) {
                fieldDiffCounts[field] = (fieldDiffCounts[field] || 0) + 1;
              }
            });
          });
          
          differingFields = Object.entries(fieldDiffCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map(([field, count]) => ({ 
              field, 
              label: COLUMN_LABELS[field] || field,
              groupsResolved: count 
            }));
        }
        
        if (bestField) {
          suggestedField = bestField;
        } else if (differingFields.length > 0) {
          // No single field achieves improvement, but we found differing fields
          suggestedField = { 
            noImprovement: true, 
            differingFields,
            message: 'No single additional field improves uniqueness. These fields differ between duplicates:'
          };
        } else {
          // Duplicates are truly identical in all fields
          suggestedField = {
            noImprovement: true,
            identical: true,
            message: 'Duplicate patterns appear identical across all fields. Review source data for true duplicates.'
          };
        }
      }

      const stats = {
        total: rows.length,
        hazmat: rows.filter(r => r._tags.includes('HazMat')).length,
        crossBorder: rows.filter(r => r._tags.includes('Cross Border')).length,
        rule11: rows.filter(r => r._tags.includes('Rule 11')).length,
        cartaPorte: rows.filter(r => r._tags.includes('Carta Porte')).length,
      };

      const crossBorderRoutes = {};
      rows.filter(r => r._tags.includes('Cross Border')).forEach(r => {
        const rt = `${r.origin_country} to ${r.destination_country}`;
        crossBorderRoutes[rt] = (crossBorderRoutes[rt] || 0) + 1;
      });

      const carrierCounts = {};
      rows.forEach(r => {
        const c = (r.route || '').split('-')[0].trim() || 'Unknown';
        carrierCounts[c] = (carrierCounts[c] || 0) + 1;
      });

      return {
        rows,
        pmkResults: pmkLevels,
        winningLevel: pmkLevels.find(l => l.uniqueness === 100) || pmkLevels[pmkLevels.length - 1],
        suggestedField,
        atRiskPatterns,
        stats,
        crossBorderRoutes,
        topCarriers: Object.entries(carrierCounts).sort((a, b) => b[1] - a[1]).slice(0, 5),
      };
    };

    // Components
    const StatusPill = ({ type }) => {
      const styles = {'HazMat':'bg-indigo-100 text-indigo-800','Cross Border':'bg-teal-100 text-teal-800','Domestic':'bg-emerald-100 text-emerald-800','Rule 11':'bg-cyan-100 text-cyan-800','Prepaid':'bg-sky-100 text-sky-800','Carta Porte':'bg-orange-100 text-orange-800'};
      return <span className={`px-2 py-0.5 text-xs font-medium rounded ${styles[type] || 'bg-gray-100 text-gray-700'}`}>{type}</span>;
    };

    const Sidebar = ({ activeNav, setActiveNav, selectedCompany, setSelectedCompany, bookingExpanded, setBookingExpanded }) => {
      const [companyOpen, setCompanyOpen] = useState(false);
      const [patExpanded, setPatExpanded] = useState(true);
      const companies = ['[CP] Acme Inc.', 'Globex', 'Soylent'];
      const bookingItems = [
        { id: 'pat', label: 'PAT', icon: Icons.Zap, children: [
          { id: 'analysis', label: 'Pattern Analysis', icon: Icons.BarChart3 },
          { id: 'converter', label: 'Pattern Converter', icon: Icons.ArrowRightLeft },
        ]},
        { id: 'patterns', label: 'Patterns', icon: Icons.Layers },
        { id: 'requests', label: 'Booking Requests', icon: Icons.ClipboardList, disabled: true },
      ];

      const isPatActive = activeNav === 'analysis' || activeNav === 'converter';

      return (
        <div className="w-64 bg-slate-900 text-slate-100 flex flex-col h-screen fixed left-0 top-0 z-50">
          <div className="p-4 border-b border-slate-700">
            <div className="flex items-center gap-3">
              <div className="w-9 h-9 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center font-bold text-white text-sm">PAT</div>
              <div><h1 className="font-bold text-sm">PAT</h1><p className="text-xs text-slate-400">AI-Powered Pattern Analysis</p></div>
            </div>
          </div>
          <div className="p-3 border-b border-slate-700 relative">
            <button onClick={() => setCompanyOpen(!companyOpen)} className="w-full flex items-center justify-between px-3 py-2 bg-slate-800 rounded-lg">
              <span className="text-sm font-medium truncate">{selectedCompany}</span>
              <Icons.ChevronDown size={16} className={`text-slate-400 ${companyOpen ? 'rotate-180' : ''}`} />
            </button>
            {companyOpen && (
              <div className="absolute top-full left-3 right-3 mt-1 bg-slate-800 rounded-lg shadow-xl border border-slate-700 z-50">
                {companies.map(c => <button key={c} onClick={() => { setSelectedCompany(c); setCompanyOpen(false); }} className={`w-full text-left px-3 py-2 text-sm hover:bg-slate-700 ${selectedCompany === c ? 'bg-slate-700 text-blue-400' : ''}`}>{c}</button>)}
              </div>
            )}
          </div>
          <nav className="flex-1 p-3 overflow-y-auto">
            <button onClick={() => setBookingExpanded(!bookingExpanded)} className="w-full flex items-center justify-between px-3 py-2 text-slate-400 hover:text-slate-200 rounded-lg hover:bg-slate-800">
              <span className="text-xs font-semibold uppercase tracking-wider">Booking</span>
              {bookingExpanded ? <Icons.ChevronDown size={14} /> : <Icons.ChevronRight size={14} />}
            </button>
            {bookingExpanded && (
              <ul className="mt-1 space-y-1 ml-2">
                {bookingItems.map(item => (
                  <li key={item.id}>
                    {item.children ? (
                      // PAT with nested menu
                      <div>
                        <button 
                          onClick={() => setPatExpanded(!patExpanded)}
                          className={`w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm font-medium ${isPatActive ? 'bg-blue-600/20 text-blue-400' : 'text-slate-300 hover:bg-slate-800'}`}
                        >
                          <div className="flex items-center gap-3">
                            <item.icon size={16} />
                            {item.label}
                          </div>
                          {patExpanded ? <Icons.ChevronDown size={14} /> : <Icons.ChevronRight size={14} />}
                        </button>
                        {patExpanded && (
                          <ul className="mt-1 space-y-1 ml-6">
                            {item.children.map(child => (
                              <li key={child.id}>
                                <button 
                                  onClick={() => setActiveNav(child.id)}
                                  className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm ${activeNav === child.id ? 'bg-blue-600/20 text-blue-400' : 'text-slate-400 hover:bg-slate-800 hover:text-slate-200'}`}
                                >
                                  <child.icon size={14} />
                                  {child.label}
                                </button>
                              </li>
                            ))}
                          </ul>
                        )}
                      </div>
                    ) : (
                      // Regular items
                      <button 
                        onClick={() => !item.disabled && setActiveNav(item.id)} 
                        disabled={item.disabled}
                        className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium ${item.disabled ? 'text-slate-600 cursor-not-allowed' : activeNav === item.id ? 'bg-blue-600/20 text-blue-400' : 'text-slate-300 hover:bg-slate-800'}`}
                      >
                        <item.icon size={16} />{item.label}{item.disabled && <span className="text-xs text-slate-600 ml-auto">Soon</span>}
                      </button>
                    )}
                  </li>
                ))}
              </ul>
            )}
          </nav>
          <div className="p-3 border-t border-slate-700">
            <div className="flex items-center gap-3 px-2">
              <div className="w-8 h-8 bg-slate-700 rounded-full flex items-center justify-center"><Icons.User size={16} className="text-slate-400" /></div>
              <div><p className="text-sm font-medium">Guest User</p><p className="text-xs text-slate-500">Logistics Analyst</p></div>
            </div>
          </div>
        </div>
      );
    };

    const ProjectSelector = ({ projects, currentProject, setCurrentProject, onNewProject, onDeleteProject }) => {
      const [open, setOpen] = useState(false);
      const [newName, setNewName] = useState('');
      const [showNew, setShowNew] = useState(false);

      return (
        <div className="relative">
          <button onClick={() => setOpen(!open)} className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-medium text-slate-700">
            <Icons.FolderOpen size={16} className="text-slate-500" />
            {currentProject ? currentProject.name : 'No Project'}
            <Icons.ChevronDown size={14} className={`text-slate-400 ${open ? 'rotate-180' : ''}`} />
          </button>
          {open && (
            <div className="absolute top-full right-0 mt-1 w-64 bg-white rounded-lg shadow-xl border z-50">
              <div className="p-2 border-b">
                <button onClick={() => { setCurrentProject(null); setOpen(false); }} className={`w-full text-left px-3 py-2 text-sm rounded hover:bg-slate-100 ${!currentProject ? 'bg-blue-50 text-blue-700' : ''}`}>No Project (standalone)</button>
              </div>
              {projects.length > 0 && (
                <div className="max-h-48 overflow-y-auto p-2 border-b">
                  {projects.map(p => (
                    <div key={p.id} className={`flex items-center justify-between px-3 py-2 rounded hover:bg-slate-100 ${currentProject?.id === p.id ? 'bg-blue-50' : ''}`}>
                      <button onClick={() => { setCurrentProject(p); setOpen(false); }} className={`flex-1 text-left text-sm ${currentProject?.id === p.id ? 'text-blue-700 font-medium' : ''}`}>
                        {p.name} <span className="text-xs text-slate-400">({p.patterns?.length || 0})</span>
                      </button>
                      <button onClick={() => onDeleteProject(p.id)} className="p-1 text-slate-400 hover:text-red-500"><Icons.Trash2 size={14} /></button>
                    </div>
                  ))}
                </div>
              )}
              <div className="p-2">
                {showNew ? (
                  <div className="flex gap-2">
                    <input type="text" value={newName} onChange={e => setNewName(e.target.value)} placeholder="Project name..." className="flex-1 px-2 py-1.5 text-sm border rounded" autoFocus onKeyDown={e => { if (e.key === 'Enter' && newName.trim()) { onNewProject(newName.trim()); setNewName(''); setShowNew(false); setOpen(false); }}} />
                    <button onClick={() => { if (newName.trim()) { onNewProject(newName.trim()); setNewName(''); setShowNew(false); setOpen(false); }}} className="px-3 py-1.5 bg-blue-600 text-white text-sm rounded">Create</button>
                  </div>
                ) : (
                  <button onClick={() => setShowNew(true)} className="w-full flex items-center gap-2 px-3 py-2 text-sm text-blue-600 hover:bg-blue-50 rounded"><Icons.Plus size={14} />New Project</button>
                )}
              </div>
            </div>
          )}
        </div>
      );
    };

    const StatCard = ({ icon: Icon, label, value, sublabel, color = 'blue' }) => {
      const colors = { blue: 'bg-blue-50 text-blue-600', indigo: 'bg-indigo-50 text-indigo-600', teal: 'bg-teal-50 text-teal-600', cyan: 'bg-cyan-50 text-cyan-600', orange: 'bg-orange-50 text-orange-600' };
      return (
        <div className="bg-white rounded-xl border p-4">
          <div className="flex items-start justify-between">
            <div><p className="text-xs font-medium text-slate-500 uppercase">{label}</p><p className="text-2xl font-bold text-slate-800 mt-1">{value}</p>{sublabel && <p className="text-xs text-slate-500 mt-1">{sublabel}</p>}</div>
            <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${colors[color]}`}><Icon size={20} /></div>
          </div>
        </div>
      );
    };

    const PMKCard = ({ pmkResults, winningLevel, suggestedField, atRiskPatterns }) => {
      const [showAtRisk, setShowAtRisk] = React.useState(false);
      const totalDuplicates = atRiskPatterns?.reduce((sum, g) => sum + g.count, 0) || 0;
      
      return (
        <div className="bg-white rounded-xl border overflow-hidden">
          <div className="px-5 py-4 border-b bg-slate-50"><h3 className="font-bold text-slate-800">PMK Analysis</h3></div>
          <div className="p-5 space-y-3">
            {pmkResults.map(l => (
              <div key={l.level} className={`flex items-center gap-3 p-3 rounded-lg border ${l.uniqueness === 100 ? 'bg-emerald-50 border-emerald-200' : 'bg-slate-50'}`}>
                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${l.uniqueness === 100 ? 'bg-emerald-500 text-white' : 'bg-slate-300 text-slate-600'}`}>
                  {l.uniqueness === 100 ? <Icons.Check size={16} /> : l.level}
                </div>
                <div className="flex-1">
                  <p className={`text-sm font-medium ${l.uniqueness === 100 ? 'text-emerald-800' : 'text-slate-600'}`}>Level {l.level}: {l.displayFields}</p>
                  <div className="flex items-center gap-2 mt-1">
                    <div className="flex-1 h-1.5 bg-slate-200 rounded-full"><div className={`h-full rounded-full ${l.uniqueness === 100 ? 'bg-emerald-500' : 'bg-blue-500'}`} style={{ width: `${l.uniqueness}%` }} /></div>
                    <span className="text-xs font-medium">{l.uniqueness.toFixed(1)}%</span>
                  </div>
                </div>
              </div>
            ))}
            {winningLevel.uniqueness === 100 ? (
              <div className="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <div className="flex items-center gap-2"><Icons.Zap size={16} className="text-blue-600" /><span className="text-sm font-bold text-blue-800">Winning Combination</span></div>
                <p className="text-sm text-blue-700 mt-1">{winningLevel.displayFields}</p>
              </div>
            ) : (
              <div className="mt-4 space-y-3">
                <div className="p-4 bg-amber-50 rounded-lg border border-amber-200">
                  <div className="flex items-center gap-2"><Icons.AlertTriangle size={16} className="text-amber-600" /><span className="text-sm font-bold text-amber-800">100% Uniqueness Not Achieved</span></div>
                  <p className="text-sm text-amber-700 mt-1">Current best: {winningLevel.displayFields} ({winningLevel.uniqueness.toFixed(1)}%)</p>
                </div>
                {suggestedField && !suggestedField.noImprovement && (
                  <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div className="flex items-center gap-2"><Icons.Zap size={16} className="text-blue-600" /><span className="text-sm font-bold text-blue-800">Recommended Additional Field</span></div>
                    <p className="text-sm text-blue-700 mt-1">
                      Adding <strong>{suggestedField.label}</strong> would increase uniqueness to <strong>{suggestedField.uniqueness.toFixed(1)}%</strong>
                    </p>
                    {suggestedField.uniqueness === 100 && (
                      <p className="text-xs text-emerald-600 mt-1 font-medium">Ã¢Å“â€œ This would achieve 100% uniqueness</p>
                    )}
                  </div>
                )}
                {suggestedField && suggestedField.noImprovement && !suggestedField.identical && suggestedField.differingFields && (
                  <div className="p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <div className="flex items-center gap-2"><Icons.Search size={16} className="text-purple-600" /><span className="text-sm font-bold text-purple-800">Analysis: Fields That Differ Between Duplicates</span></div>
                    <p className="text-sm text-purple-700 mt-1">{suggestedField.message}</p>
                    <div className="mt-2 space-y-1">
                      {suggestedField.differingFields.map((f, i) => (
                        <div key={i} className="flex items-center justify-between text-sm">
                          <span className="text-purple-800 font-medium">{f.label}</span>
                          <span className="text-purple-600 text-xs">differs in {f.groupsResolved} group{f.groupsResolved > 1 ? 's' : ''}</span>
                        </div>
                      ))}
                    </div>
                    <p className="text-xs text-purple-600 mt-2">Consider using one of these fields to differentiate patterns, or review if these are true duplicates.</p>
                  </div>
                )}
                {suggestedField && suggestedField.noImprovement && suggestedField.identical && (
                  <div className="p-4 bg-slate-100 rounded-lg border border-slate-300">
                    <div className="flex items-center gap-2"><Icons.AlertCircle size={16} className="text-slate-600" /><span className="text-sm font-bold text-slate-800">True Duplicates Detected</span></div>
                    <p className="text-sm text-slate-600 mt-1">{suggestedField.message}</p>
                  </div>
                )}
                {atRiskPatterns && atRiskPatterns.length > 0 && (
                  <div className="border border-red-200 rounded-lg overflow-hidden">
                    <button 
                      onClick={() => setShowAtRisk(!showAtRisk)}
                      className="w-full p-4 bg-red-50 flex items-center justify-between hover:bg-red-100 transition-colors"
                    >
                      <div className="flex items-center gap-2">
                        <Icons.AlertCircle size={16} className="text-red-600" />
                        <span className="text-sm font-bold text-red-800">
                          {atRiskPatterns.length} Duplicate Group{atRiskPatterns.length > 1 ? 's' : ''} ({totalDuplicates} patterns at risk)
                        </span>
                      </div>
                      <Icons.ChevronDown size={16} className={`text-red-600 transition-transform ${showAtRisk ? 'rotate-180' : ''}`} />
                    </button>
                    {showAtRisk && (
                      <div className="max-h-64 overflow-y-auto divide-y divide-red-100">
                        {atRiskPatterns.map((group, i) => (
                          <div key={i} className="p-3 bg-white">
                            <p className="text-xs font-semibold text-red-700 mb-2">
                              Duplicate Group {i + 1}: {group.count} patterns share same PMK
                            </p>
                            <div className="space-y-1">
                              {group.patterns.map((p, j) => (
                                <div key={j} className="flex items-center gap-2 text-xs">
                                  <span className="w-5 h-5 bg-red-100 text-red-700 rounded flex items-center justify-center font-medium">{j + 1}</span>
                                  <span className="font-medium text-slate-800 truncate flex-1">{p.name}</span>
                                  {p.shipper && <span className="text-slate-500 truncate max-w-[100px]" title={p.shipper}>S: {p.shipper}</span>}
                                  {p.consignee && <span className="text-slate-500 truncate max-w-[100px]" title={p.consignee}>C: {p.consignee}</span>}
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      );
    };

    const BuildModal = ({ isOpen, onClose, patterns, onBuild }) => {
      const [isBuilding, setIsBuilding] = React.useState(false);
      const [buildComplete, setBuildComplete] = React.useState(false);

      if (!isOpen) return null;

      const handleBuild = async () => {
        setIsBuilding(true);
        // Simulate API call delay
        await new Promise(resolve => setTimeout(resolve, 1500));
        onBuild(patterns);
        setIsBuilding(false);
        setBuildComplete(true);
      };

      const handleClose = () => {
        setBuildComplete(false);
        onClose();
      };

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center"><div className="absolute inset-0 bg-black/50" onClick={handleClose} />
          <div className="relative bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
            <div className="px-6 py-5 border-b bg-gradient-to-r from-indigo-600 to-purple-600">
              <div className="flex items-center gap-3"><div className="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center"><Icons.Rocket size={20} className="text-white" /></div>
                <div><h2 className="text-lg font-bold text-white">Build Patterns</h2><p className="text-sm text-indigo-200">{patterns?.length || 0} patterns ready</p></div>
              </div>
            </div>
            <div className="p-6">
              {buildComplete ? (
                <div className="text-center">
                  <div className="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <Icons.Check size={32} className="text-emerald-600" />
                  </div>
                  <h3 className="font-bold text-slate-800 text-lg mb-2">Patterns Built Successfully!</h3>
                  <p className="text-sm text-slate-600">{patterns?.length} patterns have been created and are now available in the Patterns tab.</p>
                </div>
              ) : isBuilding ? (
                <div className="text-center py-4">
                  <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                  <p className="text-sm text-slate-600">Building patterns...</p>
                </div>
              ) : (
                <div>
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <div className="flex gap-3">
                      <Icons.Package size={20} className="text-blue-600 flex-shrink-0" />
                      <div>
                        <h3 className="font-semibold text-blue-800 text-sm">Ready to Build</h3>
                        <p className="text-sm text-blue-700 mt-1">This will create {patterns?.length || 0} patterns in your pattern library.</p>
                      </div>
                    </div>
                  </div>
                  <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                    <div className="flex gap-3">
                      <Icons.AlertTriangle size={20} className="text-amber-600 flex-shrink-0" />
                      <div>
                        <h3 className="font-semibold text-amber-800 text-sm">Note</h3>
                        <p className="text-sm text-amber-700 mt-1">In production, this will create real patterns that can be used for booking. Matching patterns will be overwritten.</p>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
            <div className="px-6 py-4 bg-slate-50 border-t flex justify-end gap-3">
              {buildComplete ? (
                <button onClick={handleClose} className="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700">Done</button>
              ) : (
                <>
                  <button onClick={handleClose} disabled={isBuilding} className="px-4 py-2 text-sm text-slate-700 hover:bg-slate-200 rounded-lg disabled:opacity-50">Cancel</button>
                  <button onClick={handleBuild} disabled={isBuilding} className="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 disabled:opacity-50 flex items-center gap-2">
                    <Icons.Rocket size={16} />
                    Build {patterns?.length || 0} Patterns
                  </button>
                </>
              )}
            </div>
          </div>
        </div>
      );
    };

    const DataTable = ({ data, sortConfig, setSortConfig, filters, setFilters }) => {
      // Show all template columns plus the tags column
      const cols = ['telegraph_pattern_name', '_tags', ...TEMPLATE_COLUMNS.filter(c => c !== 'telegraph_pattern_name')];
      const filtered = useMemo(() => data.filter(r => Object.entries(filters).every(([k, v]) => !v || (r[k] || '').toString().toLowerCase().includes(v.toLowerCase()))), [data, filters]);
      const sorted = useMemo(() => {
        if (!sortConfig.key) return filtered;
        return [...filtered].sort((a, b) => {
          const cmp = (a[sortConfig.key] || '').toString().localeCompare((b[sortConfig.key] || '').toString(), undefined, { numeric: true });
          return sortConfig.direction === 'asc' ? cmp : -cmp;
        });
      }, [filtered, sortConfig]);

      return (
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="bg-slate-100 border-b">
                {cols.map(c => (
                  <th key={c} className="text-left font-semibold text-slate-700 px-3 py-2 whitespace-nowrap">
                    {c === '_tags' ? 'Tags' : (
                      <button onClick={() => setSortConfig({ key: c, direction: sortConfig.key === c && sortConfig.direction === 'asc' ? 'desc' : 'asc' })} className="flex items-center gap-1 hover:text-blue-600">
                        {COLUMN_LABELS[c] || c}<Icons.ArrowUpDown size={12} className="text-slate-400" />
                      </button>
                    )}
                  </th>
                ))}
              </tr>
              <tr className="bg-slate-50 border-b">
                {cols.map(c => (
                  <th key={`f-${c}`} className="px-2 py-1">
                    {c !== '_tags' && <input type="text" value={filters[c] || ''} onChange={e => setFilters({ ...filters, [c]: e.target.value })} placeholder="Filter..." className="w-full px-2 py-1 text-xs border rounded min-w-[60px]" />}
                  </th>
                ))}
              </tr>
            </thead>
            <tbody className="divide-y">
              {sorted.map((r, i) => (
                <tr key={i} className="hover:bg-blue-50/50">
                  {cols.map(c => (
                    <td key={c} className="px-3 py-2 whitespace-nowrap max-w-[200px] truncate">
                      {c === '_tags' ? <div className="flex flex-wrap gap-1">{(r._tags || []).map((t, j) => <StatusPill key={j} type={t} />)}</div>
                        : c === 'telegraph_pattern_name' ? <span className="font-medium" title={r[c]}>{r[c] || `${r.stcc || ''} - ${r.origin_city || ''} - ${r.destination_city || ''}`}</span>
                        : <span title={r[c] || ''}>{r[c] || 'Ã¢â‚¬â€'}</span>}
                    </td>
                  ))}
                </tr>
              ))}
            </tbody>
          </table>
          {sorted.length === 0 && <div className="text-center py-8 text-slate-500">No data</div>}
          <div className="p-3 bg-slate-50 border-t text-xs text-slate-500">
            Showing all {cols.length} columns ({sorted.length} rows)
          </div>
        </div>
      );
    };

    // Data Quality Analysis
    const analyzeDataQuality = (data) => {
      const issues = [];

      data.forEach((row, i) => {
        const name = row.telegraph_pattern_name || `Row ${i + 1}`;
        const pt = (row.payment_type || '').toLowerCase();
        const oc = (row.origin_country || '').toUpperCase();
        const dc = (row.destination_country || '').toUpperCase();
        const isCrossBorderCA = (oc === 'CA' || dc === 'CA') && oc !== dc;
        const isCrossBorderMX = (oc === 'MX' || dc === 'MX') && oc !== dc;
        const isRule11 = pt.includes('11') || pt.includes('rule11') || pt.includes('rule 11');
        const isPrepaid = pt.includes('pp') || pt.includes('prepaid') || pt.includes('pre');
        const rowIssues = [];

        // Always required: Shipper
        if (!row.shipper_name && !row.shipper_address) {
          rowIssues.push({ field: 'Shipper', rule: 'Required for all patterns', severity: 'error' });
        }
        // Always required: Consignee
        if (!row.consignee_name && !row.consignee_address) {
          rowIssues.push({ field: 'Consignee', rule: 'Required for all patterns', severity: 'error' });
        }
        // Prepaid: Freight Payor required
        if (isPrepaid && !row.freight_payor_name && !row.freight_payor_address) {
          rowIssues.push({ field: 'Freight Payor', rule: 'Required when payment type is Prepaid', severity: 'error' });
        }
        // Rule 11: Rule 11 party required
        if (isRule11 && !row.rule11_name && !row.rule11_address) {
          rowIssues.push({ field: 'Rule 11 Party', rule: 'Required when payment type includes Rule 11', severity: 'error' });
        }
        // Cross-border CA: CAN broker required
        if (isCrossBorderCA && !row.can_broker_name && !row.can_broker_address) {
          rowIssues.push({ field: 'Canadian Broker', rule: 'Required for cross-border shipments into/from Canada', severity: 'warning' });
        }
        // Cross-border MX: MX broker required
        if (isCrossBorderMX && !row.mx_broker_name && !row.mx_broker_address) {
          rowIssues.push({ field: 'Mexico Broker', rule: 'Required for cross-border shipments into/from Mexico', severity: 'warning' });
        }
        // Any MX origin or destination: MX-specific fields + importer required
        const involvesMX = oc === 'MX' || dc === 'MX';
        if (involvesMX) {
          if (!row.mx_unc) rowIssues.push({ field: 'MX UNC', rule: 'Required when origin or destination is Mexico', severity: 'error' });
          if (!row.mx_mmt) rowIssues.push({ field: 'MX MMT', rule: 'Required when origin or destination is Mexico', severity: 'error' });
          if (!row.mx_mtc) rowIssues.push({ field: 'MX MTC', rule: 'Required when origin or destination is Mexico', severity: 'error' });
          if (!row.mx_mpc) rowIssues.push({ field: 'MX MPC', rule: 'Required when origin or destination is Mexico', severity: 'error' });
          if (!row.mx_taxpayer_id) rowIssues.push({ field: 'MX Taxpayer ID', rule: 'Required when origin or destination is Mexico', severity: 'error' });
          if (!row.importer_address && !row.importer_city) rowIssues.push({ field: 'Importer Party', rule: 'Required when origin or destination is Mexico', severity: 'error' });
        }

        if (rowIssues.length > 0) {
          issues.push({ rowIndex: i, name, issues: rowIssues });
        }
      });

      const errorCount = issues.reduce((s, r) => s + r.issues.filter(i => i.severity === 'error').length, 0);
      const warningCount = issues.reduce((s, r) => s + r.issues.filter(i => i.severity === 'warning').length, 0);
      return { issues, errorCount, warningCount, affectedCount: issues.length };
    };

    const DataQualityCard = ({ data }) => {
      const [expanded, setExpanded] = useState(false);
      const [showAll, setShowAll] = useState(false);
      const quality = useMemo(() => analyzeDataQuality(data), [data]);
      const { issues, errorCount, warningCount, affectedCount } = quality;
      const isClean = affectedCount === 0;
      const displayIssues = showAll ? issues : issues.slice(0, 5);

      return (
        <div className={`rounded-xl border overflow-hidden ${isClean ? 'bg-white' : 'bg-white'}`}>
          <button
            onClick={() => setExpanded(!expanded)}
            className={`w-full px-5 py-4 border-b flex items-center justify-between ${isClean ? 'bg-emerald-50' : errorCount > 0 ? 'bg-red-50' : 'bg-amber-50'}`}
          >
            <div className="flex items-center gap-3">
              {isClean
                ? <Icons.Check size={20} className="text-emerald-600" />
                : errorCount > 0
                  ? <Icons.AlertCircle size={20} className="text-red-600" />
                  : <Icons.AlertTriangle size={20} className="text-amber-600" />
              }
              <div className="text-left">
                <h3 className={`font-bold text-sm ${isClean ? 'text-emerald-800' : errorCount > 0 ? 'text-red-800' : 'text-amber-800'}`}>
                  Data Quality
                </h3>
                <p className={`text-xs ${isClean ? 'text-emerald-600' : errorCount > 0 ? 'text-red-600' : 'text-amber-600'}`}>
                  {isClean
                    ? 'All patterns pass quality checks'
                    : `${affectedCount} pattern${affectedCount > 1 ? 's' : ''} need attention Â· ${errorCount > 0 ? `${errorCount} error${errorCount > 1 ? 's' : ''}` : ''}${errorCount > 0 && warningCount > 0 ? ', ' : ''}${warningCount > 0 ? `${warningCount} warning${warningCount > 1 ? 's' : ''}` : ''}`
                  }
                </p>
              </div>
            </div>
            <div className="flex items-center gap-3">
              {!isClean && (
                <div className="flex gap-2">
                  {errorCount > 0 && <span className="px-2 py-0.5 bg-red-100 text-red-700 text-xs font-medium rounded-full">{errorCount} errors</span>}
                  {warningCount > 0 && <span className="px-2 py-0.5 bg-amber-100 text-amber-700 text-xs font-medium rounded-full">{warningCount} warnings</span>}
                </div>
              )}
              <Icons.ChevronDown size={16} className={`text-slate-400 transition-transform ${expanded ? 'rotate-180' : ''}`} />
            </div>
          </button>

          {expanded && (
            <div className="p-5">
              {isClean ? (
                <div className="flex items-center gap-3 text-emerald-700 text-sm">
                  <Icons.Check size={16} className="text-emerald-500" />
                  All required parties (Shipper, Consignee, Freight Payor, Rule 11, brokers) are present where needed.
                </div>
              ) : (
                <div className="space-y-3">
                  <p className="text-xs text-slate-500 mb-2">
                    The following patterns are missing critical party information. Fix these in your source file and re-upload.
                  </p>
                  {displayIssues.map((row, i) => (
                    <div key={i} className="border border-slate-200 rounded-lg overflow-hidden">
                      <div className="px-3 py-2 bg-slate-50 flex items-center gap-2">
                        <span className="text-xs font-semibold text-slate-700 truncate">{row.name}</span>
                        <span className="ml-auto flex gap-1">
                          {row.issues.filter(x => x.severity === 'error').length > 0 && (
                            <span className="px-1.5 py-0.5 bg-red-100 text-red-700 text-xs rounded">{row.issues.filter(x => x.severity === 'error').length} error{row.issues.filter(x => x.severity === 'error').length > 1 ? 's' : ''}</span>
                          )}
                          {row.issues.filter(x => x.severity === 'warning').length > 0 && (
                            <span className="px-1.5 py-0.5 bg-amber-100 text-amber-700 text-xs rounded">{row.issues.filter(x => x.severity === 'warning').length} warning{row.issues.filter(x => x.severity === 'warning').length > 1 ? 's' : ''}</span>
                          )}
                        </span>
                      </div>
                      <div className="divide-y divide-slate-100">
                        {row.issues.map((issue, j) => (
                          <div key={j} className="flex items-center gap-3 px-3 py-2">
                            {issue.severity === 'error'
                              ? <Icons.AlertCircle size={14} className="text-red-500 flex-shrink-0" />
                              : <Icons.AlertTriangle size={14} className="text-amber-500 flex-shrink-0" />
                            }
                            <span className={`text-xs font-medium ${issue.severity === 'error' ? 'text-red-700' : 'text-amber-700'} w-32 flex-shrink-0`}>{issue.field}</span>
                            <span className="text-xs text-slate-500">{issue.rule}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                  {issues.length > 5 && (
                    <button
                      onClick={() => setShowAll(!showAll)}
                      className="text-xs text-blue-600 hover:text-blue-800 font-medium"
                    >
                      {showAll ? 'Show fewer' : `Show ${issues.length - 5} more affected patterns`}
                    </button>
                  )}
                  <div className="mt-3 p-3 bg-slate-50 rounded-lg border border-slate-200 text-xs text-slate-600">
                    <strong>How to fix:</strong> Update your source file with the missing party details, then re-upload via the Pattern Converter.
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      );
    };

    // Pattern Analysis Page
    const PatternAnalysis = ({ data, onClear, onBuildPatterns }) => {
      const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });
      const [filters, setFilters] = useState({});
      const [showBuild, setShowBuild] = useState(false);
      const analysis = useMemo(() => data.length ? analyzeData(data) : null, [data]);

      const handleBuild = (patterns) => {
        // Add metadata to patterns
        const now = new Date().toISOString();
        const enrichedPatterns = patterns.map(p => ({
          ...p,
          createdAt: now,
          createdBy: 'Guest User',
        }));
        onBuildPatterns(enrichedPatterns);
      };

      if (!data.length) {
        return (
          <div className="flex items-center justify-center min-h-[60vh]">
            <div className="bg-white rounded-xl shadow-lg border p-8 max-w-md text-center">
              <div className="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-6"><Icons.FileSpreadsheet size={32} className="text-blue-600" /></div>
              <h2 className="text-xl font-bold text-slate-800 mb-2">No Pattern Data</h2>
              <p className="text-slate-500 mb-6 text-sm">Upload patterns via the Pattern Converter or load data into a project.</p>
              <a href="https://docs.google.com/spreadsheets/d/1FxzjMzE5KFdJhxvVTDaEa9WiIiazmwmqRZ97pyh5yPY/edit?gid=0#gid=0" target="_blank" className="inline-flex items-center gap-1 text-sm text-blue-600"><Icons.ExternalLink size={14} />View Template</a>
            </div>
          </div>
        );
      }

      const cbLabel = Object.entries(analysis.crossBorderRoutes).map(([r, c]) => `${r}(${c})`).join(', ') || 'None';

      return (
        <div className="space-y-6">
          <div className="grid grid-cols-5 gap-4">
            <StatCard icon={Icons.Package} label="Total Patterns" value={analysis.stats.total} color="blue" />
            <StatCard icon={Icons.AlertCircle} label="Hazardous" value={analysis.stats.hazmat} sublabel={`${analysis.stats.total ? ((analysis.stats.hazmat / analysis.stats.total) * 100).toFixed(0) : 0}%`} color="indigo" />
            <StatCard icon={Icons.Globe} label="Cross Border" value={analysis.stats.crossBorder} sublabel={cbLabel} color="teal" />
            <StatCard icon={Icons.Truck} label="Rule 11" value={analysis.stats.rule11} sublabel={`${analysis.stats.total ? ((analysis.stats.rule11 / analysis.stats.total) * 100).toFixed(0) : 0}%`} color="cyan" />
            <StatCard icon={Icons.FileText} label="Carta Porte" value={analysis.stats.cartaPorte} sublabel={`${analysis.stats.total ? ((analysis.stats.cartaPorte / analysis.stats.total) * 100).toFixed(0) : 0}%`} color="orange" />
          </div>
          <DataQualityCard data={data} />
          <div className="grid grid-cols-2 gap-6">
            <PMKCard pmkResults={analysis.pmkResults} winningLevel={analysis.winningLevel} suggestedField={analysis.suggestedField} atRiskPatterns={analysis.atRiskPatterns} />
            <div className="bg-white rounded-xl border overflow-hidden">
              <div className="px-5 py-4 border-b bg-slate-50"><h3 className="font-bold text-slate-800">Top Origin Carriers</h3></div>
              <div className="p-5 space-y-3">
                {analysis.topCarriers.map(([c, n]) => (
                  <div key={c} className="flex items-center gap-3">
                    <span className="w-16 text-sm font-medium truncate">{c}</span>
                    <div className="flex-1 h-6 bg-slate-100 rounded overflow-hidden">
                      <div className="h-full bg-gradient-to-r from-blue-500 to-blue-600 rounded flex items-center justify-end pr-2" style={{ width: `${analysis.topCarriers[0] ? (n / analysis.topCarriers[0][1]) * 100 : 0}%` }}>
                        <span className="text-xs font-bold text-white">{n}</span>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
          <div className="bg-white rounded-xl border overflow-hidden">
            <div className="px-5 py-4 border-b bg-slate-50 flex items-center justify-between">
              <div><h3 className="font-bold text-slate-800">Pattern Data</h3><p className="text-xs text-slate-500">{data.length} records</p></div>
              <div className="flex items-center gap-3">
                <button onClick={() => exportToCSV(data, 'patterns.csv')} className="px-3 py-1.5 text-sm border rounded-lg hover:bg-slate-50 flex items-center gap-2"><Icons.Download size={14} />CSV</button>
                <button onClick={() => exportToExcel(data, 'patterns.xlsx')} className="px-3 py-1.5 text-sm border rounded-lg hover:bg-slate-50 flex items-center gap-2"><Icons.Download size={14} />Excel</button>
                <button onClick={() => setShowBuild(true)} className="px-4 py-1.5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-sm font-medium rounded-lg flex items-center gap-2"><Icons.Rocket size={16} />Build Patterns</button>
              </div>
            </div>
            <DataTable data={analysis.rows} sortConfig={sortConfig} setSortConfig={setSortConfig} filters={filters} setFilters={setFilters} />
          </div>
          <BuildModal isOpen={showBuild} onClose={() => setShowBuild(false)} patterns={data} onBuild={handleBuild} />
        </div>
      );
    };

    // Patterns Page - Display built patterns
    const PatternsPage = ({ patterns, onCreatePattern, onDeleteAllPatterns }) => {
      const [searchTerm, setSearchTerm] = useState('');
      const [sortField, setSortField] = useState('telegraph_pattern_name');
      const [sortDirection, setSortDirection] = useState('asc');
      const [currentPage, setCurrentPage] = useState(1);
      const [resultsPerPage, setResultsPerPage] = useState(25);
      const [filters, setFilters] = useState({
        patternName: '',
        origin: '',
        destination: '',
        stcc: '',
        route: '',
      });
      const [showFilters, setShowFilters] = useState(false);

      // Filter and sort patterns
      const filteredPatterns = useMemo(() => {
        return patterns.filter(p => {
          const matchesSearch = !searchTerm || 
            (p.telegraph_pattern_name || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (p.stcc || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (p.origin_city || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (p.destination_city || '').toLowerCase().includes(searchTerm.toLowerCase());
          
          const matchesFilters = 
            (!filters.patternName || (p.telegraph_pattern_name || '').toLowerCase().includes(filters.patternName.toLowerCase())) &&
            (!filters.origin || `${p.origin_city || ''} ${p.origin_state || ''}`.toLowerCase().includes(filters.origin.toLowerCase())) &&
            (!filters.destination || `${p.destination_city || ''} ${p.destination_state || ''}`.toLowerCase().includes(filters.destination.toLowerCase())) &&
            (!filters.stcc || (p.stcc || '').includes(filters.stcc)) &&
            (!filters.route || (p.route || '').toLowerCase().includes(filters.route.toLowerCase()));
          
          return matchesSearch && matchesFilters;
        });
      }, [patterns, searchTerm, filters]);

      const sortedPatterns = useMemo(() => {
        return [...filteredPatterns].sort((a, b) => {
          const aVal = (a[sortField] || '').toString().toLowerCase();
          const bVal = (b[sortField] || '').toString().toLowerCase();
          const cmp = aVal.localeCompare(bVal, undefined, { numeric: true });
          return sortDirection === 'asc' ? cmp : -cmp;
        });
      }, [filteredPatterns, sortField, sortDirection]);

      // Pagination
      const totalPages = Math.ceil(sortedPatterns.length / resultsPerPage);
      const paginatedPatterns = sortedPatterns.slice(
        (currentPage - 1) * resultsPerPage,
        currentPage * resultsPerPage
      );

      const handleSort = (field) => {
        if (sortField === field) {
          setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
        } else {
          setSortField(field);
          setSortDirection('asc');
        }
      };

      const SortHeader = ({ field, label }) => (
        <th 
          className="text-left px-4 py-3 font-medium text-slate-600 cursor-pointer hover:text-blue-600 whitespace-nowrap"
          onClick={() => handleSort(field)}
        >
          <div className="flex items-center gap-1">
            {label}
            {sortField === field ? (
              <span className="text-blue-600">{sortDirection === 'asc' ? 'Ã¢â€ â€˜' : 'Ã¢â€ â€œ'}</span>
            ) : (
              <Icons.ArrowUpDown size={12} className="text-slate-300" />
            )}
          </div>
        </th>
      );

      const clearFilters = () => {
        setFilters({ patternName: '', origin: '', destination: '', stcc: '', route: '' });
        setSearchTerm('');
      };

      const activeFilterCount = Object.values(filters).filter(v => v).length;

      if (patterns.length === 0) {
        return (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-2xl font-bold text-slate-800">Patterns</h2>
              </div>
              <button 
                onClick={onCreatePattern}
                className="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 flex items-center gap-2"
              >
                Create Pattern
              </button>
            </div>
            
            <div className="flex items-center justify-center min-h-[50vh]">
              <div className="bg-white rounded-xl shadow-lg border p-8 max-w-md text-center">
                <div className="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-6">
                  <Icons.Layers size={32} className="text-slate-400" />
                </div>
                <h3 className="text-xl font-bold text-slate-800 mb-2">No Patterns Yet</h3>
                <p className="text-slate-500 mb-6 text-sm">
                  Build patterns from the Pattern Analysis page, or create a new pattern manually.
                </p>
                <button 
                  onClick={onCreatePattern}
                  className="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700"
                >
                  Create Pattern
                </button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="flex items-center justify-between">
            <div>
              <h2 className="text-2xl font-bold text-slate-800">Patterns</h2>
            </div>
            <button 
              onClick={onCreatePattern}
              className="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 flex items-center gap-2"
            >
              Create Pattern
            </button>
          </div>

          {/* Main Card */}
          <div className="bg-white rounded-xl shadow-lg border overflow-hidden">
            {/* Filter Bar */}
            <div className="px-4 py-3 border-b bg-slate-50">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2 flex-wrap">
                  {/* Quick filter pills */}
                  <div className="flex items-center gap-2 text-sm">
                    <span className="px-3 py-1 bg-white border rounded-full text-slate-600 flex items-center gap-1">
                      Pattern Name <span className="text-slate-400">All</span>
                    </span>
                    <span className="px-3 py-1 bg-white border rounded-full text-slate-600 flex items-center gap-1">
                      Origin <span className="text-slate-400">All</span>
                    </span>
                    <span className="px-3 py-1 bg-white border rounded-full text-slate-600 flex items-center gap-1">
                      Destination <span className="text-slate-400">All</span>
                    </span>
                    <span className="px-3 py-1 bg-white border rounded-full text-slate-600 flex items-center gap-1">
                      Commodity Code <span className="text-slate-400">All</span>
                    </span>
                    <span className="px-3 py-1 bg-white border rounded-full text-slate-600 flex items-center gap-1">
                      Booking Railroad <span className="text-slate-400">All</span>
                    </span>
                  </div>
                </div>
                <button 
                  onClick={() => setShowFilters(!showFilters)}
                  className="flex items-center gap-1 text-sm text-blue-600 hover:text-blue-800"
                >
                  Filters
                  {activeFilterCount > 0 && (
                    <span className="w-5 h-5 bg-blue-600 text-white rounded-full text-xs flex items-center justify-center">
                      {activeFilterCount}
                    </span>
                  )}
                  <Icons.ChevronDown size={16} className={`transition-transform ${showFilters ? 'rotate-180' : ''}`} />
                </button>
              </div>
              
              {/* Expanded Filters */}
              {showFilters && (
                <div className="mt-3 pt-3 border-t grid grid-cols-5 gap-3">
                  <div>
                    <label className="text-xs font-medium text-slate-500 block mb-1">Pattern Name</label>
                    <input 
                      type="text" 
                      value={filters.patternName}
                      onChange={e => setFilters({...filters, patternName: e.target.value})}
                      placeholder="Search..."
                      className="w-full px-3 py-1.5 border rounded text-sm"
                    />
                  </div>
                  <div>
                    <label className="text-xs font-medium text-slate-500 block mb-1">Origin</label>
                    <input 
                      type="text"
                      value={filters.origin}
                      onChange={e => setFilters({...filters, origin: e.target.value})}
                      placeholder="City, State..."
                      className="w-full px-3 py-1.5 border rounded text-sm"
                    />
                  </div>
                  <div>
                    <label className="text-xs font-medium text-slate-500 block mb-1">Destination</label>
                    <input 
                      type="text"
                      value={filters.destination}
                      onChange={e => setFilters({...filters, destination: e.target.value})}
                      placeholder="City, State..."
                      className="w-full px-3 py-1.5 border rounded text-sm"
                    />
                  </div>
                  <div>
                    <label className="text-xs font-medium text-slate-500 block mb-1">Commodity Code</label>
                    <input 
                      type="text"
                      value={filters.stcc}
                      onChange={e => setFilters({...filters, stcc: e.target.value})}
                      placeholder="STCC..."
                      className="w-full px-3 py-1.5 border rounded text-sm"
                    />
                  </div>
                  <div>
                    <label className="text-xs font-medium text-slate-500 block mb-1">Booking Railroad</label>
                    <input 
                      type="text"
                      value={filters.route}
                      onChange={e => setFilters({...filters, route: e.target.value})}
                      placeholder="Carrier..."
                      className="w-full px-3 py-1.5 border rounded text-sm"
                    />
                  </div>
                  {activeFilterCount > 0 && (
                    <div className="col-span-5 flex justify-end">
                      <button onClick={clearFilters} className="text-sm text-blue-600 hover:text-blue-800">
                        Clear all filters
                      </button>
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Table */}
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="border-b bg-white">
                  <tr>
                    <SortHeader field="telegraph_pattern_name" label="Pattern Name" />
                    <SortHeader field="createdAt" label="Created Date" />
                    <th className="text-left px-4 py-3 font-medium text-slate-600">Created By</th>
                    <SortHeader field="route" label="Booking Railroad" />
                    <SortHeader field="origin_city" label="Origin" />
                    <SortHeader field="destination_city" label="Destination" />
                    <SortHeader field="stcc" label="Commodity Code" />
                    <th className="px-4 py-3"></th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {paginatedPatterns.map((pattern, i) => (
                    <tr key={i} className="hover:bg-slate-50">
                      <td className="px-4 py-3">
                        <a href="#" className="text-blue-600 hover:text-blue-800 font-medium">
                          {pattern.telegraph_pattern_name || `${pattern.stcc} - ${pattern.origin_city} - ${pattern.destination_city}`}
                        </a>
                      </td>
                      <td className="px-4 py-3 text-slate-600 text-sm">
                        {pattern.createdAt ? new Date(pattern.createdAt).toLocaleDateString('en-US', { 
                          month: '2-digit', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
                        }) : 'Ã¢â‚¬â€'}
                      </td>
                      <td className="px-4 py-3 text-slate-600 text-sm">
                        {pattern.createdBy || 'Guest User'}
                      </td>
                      <td className="px-4 py-3 text-slate-600 text-sm">
                        {pattern.route || 'Ã¢â‚¬â€'}
                      </td>
                      <td className="px-4 py-3 text-slate-600 text-sm whitespace-nowrap">
                        {[pattern.origin_city, pattern.origin_state, pattern.origin_country].filter(Boolean).join(', ') || 'Ã¢â‚¬â€'}
                      </td>
                      <td className="px-4 py-3 text-slate-600 text-sm whitespace-nowrap">
                        {[pattern.destination_city, pattern.destination_state, pattern.destination_country].filter(Boolean).join(', ') || 'Ã¢â‚¬â€'}
                      </td>
                      <td className="px-4 py-3 text-slate-600 text-sm">
                        {pattern.stcc || 'Ã¢â‚¬â€'}
                      </td>
                      <td className="px-4 py-3">
                        <div className="flex items-center gap-2">
                          <button className="px-3 py-1 border rounded text-sm hover:bg-slate-100">
                            Book
                          </button>
                          <button className="p-1 text-slate-400 hover:text-slate-600">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                              <circle cx="12" cy="5" r="2"/>
                              <circle cx="12" cy="12" r="2"/>
                              <circle cx="12" cy="19" r="2"/>
                            </svg>
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {/* Pagination Footer */}
            <div className="px-4 py-3 border-t bg-slate-50 flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="text-sm text-slate-600">
                  Showing {((currentPage - 1) * resultsPerPage) + 1} to {Math.min(currentPage * resultsPerPage, sortedPatterns.length)} of {sortedPatterns.length} result(s).
                </div>
                <button
                  onClick={() => { if (window.confirm('Delete all patterns? This cannot be undone.')) onDeleteAllPatterns(); }}
                  className="text-slate-300 hover:text-red-400 transition-colors text-xs"
                  title="Delete all patterns"
                >
                  <Icons.Trash2 size={13} />
                </button>
              </div>
              <div className="flex items-center gap-4">
                <div className="flex items-center gap-2 text-sm">
                  <span className="text-slate-600">Results per page</span>
                  <select 
                    value={resultsPerPage}
                    onChange={e => { setResultsPerPage(Number(e.target.value)); setCurrentPage(1); }}
                    className="border rounded px-2 py-1"
                  >
                    <option value={10}>10</option>
                    <option value={25}>25</option>
                    <option value={50}>50</option>
                    <option value={100}>100</option>
                  </select>
                </div>
                <div className="flex items-center gap-1 text-sm">
                  <span className="text-slate-600">Page {currentPage} of {totalPages || 1}</span>
                  <button 
                    onClick={() => setCurrentPage(1)}
                    disabled={currentPage === 1}
                    className="px-2 py-1 text-slate-600 hover:text-slate-800 disabled:text-slate-300"
                  >
                    &lt; First
                  </button>
                  <button 
                    onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                    disabled={currentPage === 1}
                    className="px-2 py-1 text-slate-600 hover:text-slate-800 disabled:text-slate-300"
                  >
                    &lt;
                  </button>
                  <input 
                    type="number"
                    value={currentPage}
                    onChange={e => setCurrentPage(Math.min(totalPages, Math.max(1, Number(e.target.value) || 1)))}
                    className="w-12 border rounded px-2 py-1 text-center"
                    min={1}
                    max={totalPages}
                  />
                  <button 
                    onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                    disabled={currentPage >= totalPages}
                    className="px-2 py-1 text-slate-600 hover:text-slate-800 disabled:text-slate-300"
                  >
                    &gt;
                  </button>
                  <button 
                    onClick={() => setCurrentPage(totalPages)}
                    disabled={currentPage >= totalPages}
                    className="px-2 py-1 text-slate-600 hover:text-slate-800 disabled:text-slate-300"
                  >
                    Last &gt;
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Pattern Converter Page
    const PatternConverter = ({ onConvertComplete, onAddToProject, currentProject, projects, setCurrentProject, onNewProject }) => {
      const [step, setStep] = useState('upload'); // upload, mapping, review, preview
      const [rawData, setRawData] = useState([]);
      const [sourceColumns, setSourceColumns] = useState([]);
      const [columnMappings, setColumnMappings] = useState({});
      const [mappingConfidence, setMappingConfidence] = useState({});
      const [convertedData, setConvertedData] = useState([]);
      const [validationIssues, setValidationIssues] = useState([]);
      const [apiKey, setApiKey] = useState(() => hasApiKey());
      const [apiKeyInput, setApiKeyInput] = useState(''); // Separate input field, never shows stored key
      const [showApiKeyInput, setShowApiKeyInput] = useState(false);
      const [extractionLoading, setExtractionLoading] = useState(false);
      const [extractionError, setExtractionError] = useState(null);
      const [extractionSource, setExtractionSource] = useState(null);
      const [extractedData, setExtractedData] = useState([]); // Raw extraction for review
      const [editingCell, setEditingCell] = useState(null); // {rowIndex, field}
      const [showAddToProjectModal, setShowAddToProjectModal] = useState(false);

      const handleSaveApiKey = (key) => {
        saveApiKey(key);
        setApiKey(true); // Just track that we have a key, not the key itself
        setApiKeyInput(''); // Clear input
        setShowApiKeyInput(false);
      };

      const handleClearApiKey = () => {
        clearApiKey();
        setApiKey(false);
        setApiKeyInput('');
      };

      const handleFileUpload = async (e, sourceType = null) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const ext = file.name.split('.').pop().toLowerCase();
        
        if (ext === 'csv') {
          const text = await file.text();
          const result = Papa.parse(text, { header: true, skipEmptyLines: true });
          if (result.data.length) {
            setRawData(result.data);
            setSourceColumns(Object.keys(result.data[0]));
            autoMapColumns(Object.keys(result.data[0]));
            setStep('mapping');
          }
        } else if (ext === 'xlsx' || ext === 'xls') {
          const buffer = await file.arrayBuffer();
          const wb = XLSX.read(buffer, { type: 'array' });
          const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
          if (data.length) {
            setRawData(data);
            setSourceColumns(Object.keys(data[0]));
            autoMapColumns(Object.keys(data[0]));
            setStep('mapping');
          }
        } else if (['pdf', 'png', 'jpg', 'jpeg', 'webp'].includes(ext)) {
          // Check for API key
          if (!apiKey) {
            setShowApiKeyInput(true);
            setExtractionSource({ file, ext, sourceType });
            return;
          }
          await processImageOrPdf(file, ext, sourceType);
        }
      };

      const processImageOrPdf = async (file, ext, sourceType) => {
        setExtractionLoading(true);
        setExtractionError(null);
        
        const storedApiKey = getApiKey(); // Get from storage when needed
        
        try {
          let allPatterns = [];
          
          if (ext === 'pdf') {
            // Convert PDF pages to images and process each
            const images = await pdfToImages(file);
            for (const img of images) {
              const patterns = await extractPatternFromImage(img.base64, img.mediaType, storedApiKey);
              if (Array.isArray(patterns)) {
                allPatterns = [...allPatterns, ...patterns];
              }
            }
          } else {
            // Process single image
            const base64 = await fileToBase64(file);
            const mediaType = `image/${ext === 'jpg' ? 'jpeg' : ext}`;
            const patterns = await extractPatternFromImage(base64, mediaType, storedApiKey);
            if (Array.isArray(patterns)) {
              allPatterns = patterns;
            }
          }
          
          if (allPatterns.length === 0) {
            throw new Error('No pattern data could be extracted from this file');
          }
          
          // Ensure all patterns have all template fields (fill missing with empty string)
          const normalizedPatterns = allPatterns.map(p => {
            const normalized = {};
            TEMPLATE_COLUMNS.forEach(col => {
              normalized[col] = p[col] || '';
            });
            return normalized;
          });
          
          // Go to review step for user verification
          setExtractedData(normalizedPatterns);
          setStep('review');
        } catch (err) {
          console.error('Extraction error:', err);
          setExtractionError(err.message || 'Failed to extract data from file');
        } finally {
          setExtractionLoading(false);
        }
      };

      const handleApiKeySubmit = async () => {
        if (!apiKeyInput.trim()) return;
        handleSaveApiKey(apiKeyInput.trim());
        if (extractionSource) {
          await processImageOrPdf(extractionSource.file, extractionSource.ext, extractionSource.sourceType);
          setExtractionSource(null);
        }
      };

      const autoMapColumns = (cols) => {
        const mappings = {}, confidence = {};
        cols.forEach(col => {
          const match = fuzzyMatchColumn(col);
          if (match) { mappings[col] = match.target; confidence[col] = match.confidence; }
        });
        setColumnMappings(mappings);
        setMappingConfidence(confidence);
      };

      const processConversion = () => {
        const converted = rawData.map(row => {
          const newRow = {};
          TEMPLATE_COLUMNS.forEach(c => newRow[c] = '');
          Object.entries(columnMappings).forEach(([src, tgt]) => { if (tgt && row[src]) newRow[tgt] = row[src].toString().trim(); });
          
          // Parse locations
          Object.entries(row).forEach(([k, v]) => {
            if (!v) return;
            const kl = k.toLowerCase();
            if ((kl.includes('origin') || kl.includes('from')) && !columnMappings[k]) {
              const p = parseLocation(v.toString());
              if (p && !newRow.origin_city) { newRow.origin_city = p.city; newRow.origin_state = p.state; newRow.origin_country = p.country; }
            }
            if ((kl.includes('dest') || kl.includes('to')) && !columnMappings[k]) {
              const p = parseLocation(v.toString());
              if (p && !newRow.destination_city) { newRow.destination_city = p.city; newRow.destination_state = p.state; newRow.destination_country = p.country; }
            }
          });

          if (!newRow.telegraph_pattern_name && newRow.stcc && newRow.origin_city && newRow.destination_city) {
            newRow.telegraph_pattern_name = `${newRow.stcc} - ${newRow.origin_city} - ${newRow.destination_city}`;
          }
          return newRow;
        }).filter(r => r.origin_city || r.destination_city || r.stcc);

        const issues = [];
        converted.forEach((r, i) => {
          if (!r.origin_city) issues.push({ row: i + 1, field: 'Origin City', issue: 'Missing' });
          if (!r.destination_city) issues.push({ row: i + 1, field: 'Dest City', issue: 'Missing' });
        });

        setConvertedData(converted);
        setValidationIssues(issues);
        setStep('preview');
      };

      // API Key Modal
      const ApiKeyModal = () => (
        <div className="fixed inset-0 z-50 flex items-center justify-center"><div className="absolute inset-0 bg-black/50" onClick={() => setShowApiKeyInput(false)} />
          <div className="relative bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
            <div className="px-6 py-5 border-b bg-gradient-to-r from-blue-600 to-indigo-600">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center"><Icons.Zap size={20} className="text-white" /></div>
                <div><h2 className="text-lg font-bold text-white">{apiKey ? 'API Key Settings' : 'API Key Required'}</h2><p className="text-sm text-blue-100">For image/PDF extraction</p></div>
              </div>
            </div>
            <div className="p-6">
              {apiKey ? (
                // Key already configured - show status, option to replace or clear
                <div>
                  <div className="flex items-center gap-3 p-4 bg-emerald-50 border border-emerald-200 rounded-lg mb-4">
                    <Icons.Check size={20} className="text-emerald-600" />
                    <div>
                      <p className="text-sm font-medium text-emerald-800">API Key Configured</p>
                      <p className="text-xs text-emerald-600">Your key is securely stored and ready to use</p>
                    </div>
                  </div>
                  <p className="text-sm text-slate-600 mb-4">You can replace your key or remove it below.</p>
                  <div className="space-y-3">
                    <div>
                      <label className="text-sm font-medium text-slate-700 block mb-1">Replace with new key:</label>
                      <input 
                        type="password" 
                        value={apiKeyInput} 
                        onChange={e => setApiKeyInput(e.target.value)} 
                        placeholder="sk-ant-..." 
                        className="w-full px-4 py-3 border rounded-lg text-sm font-mono focus:outline-none focus:border-blue-500"
                        autoComplete="off"
                        spellCheck="false"
                      />
                    </div>
                  </div>
                </div>
              ) : (
                // No key - show input to add one
                <div>
                  <p className="text-sm text-slate-600 mb-4">Enter your Anthropic API key to enable AI-powered extraction from images and PDFs. Your key is stored locally and only sent directly to Anthropic's API.</p>
                  <input 
                    type="password" 
                    value={apiKeyInput} 
                    onChange={e => setApiKeyInput(e.target.value)} 
                    placeholder="sk-ant-..." 
                    className="w-full px-4 py-3 border rounded-lg text-sm font-mono focus:outline-none focus:border-blue-500"
                    onKeyDown={e => e.key === 'Enter' && handleApiKeySubmit()}
                    autoComplete="off"
                    spellCheck="false"
                  />
                  <p className="text-xs text-slate-400 mt-2">Get your key from <a href="https://console.anthropic.com/settings/keys" target="_blank" className="text-blue-600 hover:underline">console.anthropic.com</a></p>
                </div>
              )}
            </div>
            <div className="px-6 py-4 bg-slate-50 border-t flex justify-between">
              <div>
                {apiKey && (
                  <button onClick={handleClearApiKey} className="px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg">Remove Key</button>
                )}
              </div>
              <div className="flex gap-3">
                <button onClick={() => { setShowApiKeyInput(false); setApiKeyInput(''); setExtractionSource(null); }} className="px-4 py-2 text-sm text-slate-700 hover:bg-slate-200 rounded-lg">Cancel</button>
                {apiKeyInput.trim() && (
                  <button onClick={handleApiKeySubmit} className="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700">
                    {apiKey ? 'Replace Key' : 'Save & Continue'}
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      );

      // Loading overlay for extraction
      const ExtractionLoadingOverlay = () => (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
          <div className="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full mx-4 text-center">
            <div className="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <h3 className="text-lg font-bold text-slate-800 mb-2">Extracting Pattern Data</h3>
            <p className="text-sm text-slate-500">AI is analyzing your file...</p>
          </div>
        </div>
      );

      if (step === 'upload') {
        return (
          <div className="max-w-4xl mx-auto">
            {showApiKeyInput && <ApiKeyModal />}
            {extractionLoading && <ExtractionLoadingOverlay />}
            
            <div className="bg-white rounded-xl shadow-lg border p-8">
              <div className="flex items-center justify-between mb-2">
                <h2 className="text-xl font-bold text-slate-800">Pattern Converter</h2>
                {apiKey && (
                  <button onClick={() => setShowApiKeyInput(true)} className="text-xs text-slate-500 hover:text-slate-700 flex items-center gap-1">
                    <Icons.Zap size={12} />API Key Configured
                  </button>
                )}
              </div>
              <p className="text-slate-500 mb-6">Convert data from various sources into the standard pattern template format.</p>
              
              {/* Current Project Indicator */}
              {currentProject && (
                <div className="mb-6 p-4 bg-emerald-50 border border-emerald-200 rounded-lg flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <Icons.FolderOpen size={20} className="text-emerald-600" />
                    <div>
                      <p className="text-sm font-medium text-emerald-800">Adding to: {currentProject.name}</p>
                      <p className="text-xs text-emerald-600">{currentProject.patterns?.length || 0} patterns in project</p>
                    </div>
                  </div>
                  <button onClick={() => setCurrentProject(null)} className="text-xs text-emerald-600 hover:text-emerald-800">Clear selection</button>
                </div>
              )}
              
              {extractionError && (
                <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3">
                  <Icons.AlertTriangle size={20} className="text-red-600 flex-shrink-0" />
                  <div>
                    <p className="text-sm font-medium text-red-800">Extraction Failed</p>
                    <p className="text-sm text-red-600 mt-1">{extractionError}</p>
                  </div>
                  <button onClick={() => setExtractionError(null)} className="ml-auto text-red-400 hover:text-red-600"><Icons.X size={16} /></button>
                </div>
              )}
              
              <div className="grid grid-cols-2 gap-4 mb-8">
                <label className="cursor-pointer">
                  <input type="file" accept=".csv,.xlsx,.xls" onChange={e => handleFileUpload(e, 'spreadsheet')} className="hidden" />
                  <div className="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center hover:border-blue-400 hover:bg-blue-50 transition-colors">
                    <Icons.FileSpreadsheet size={32} className="mx-auto mb-3 text-slate-400" />
                    <p className="font-medium text-slate-700">Excel / CSV</p>
                    <p className="text-xs text-slate-500 mt-1">Import spreadsheet data</p>
                  </div>
                </label>
                <label className="cursor-pointer">
                  <input type="file" accept=".pdf,.png,.jpg,.jpeg,.webp" onChange={e => handleFileUpload(e, 'image')} className="hidden" />
                  <div className="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center hover:border-blue-400 hover:bg-blue-50 transition-colors">
                    <Icons.Image size={32} className="mx-auto mb-3 text-slate-400" />
                    <p className="font-medium text-slate-700">PDF / Image</p>
                    <p className="text-xs text-slate-500 mt-1">AI extracts pattern data</p>
                    {apiKey && <p className="text-xs text-emerald-600 mt-1">Ã¢Å“â€œ Ready</p>}
                  </div>
                </label>
              </div>

              <div className="bg-slate-50 rounded-lg p-4 text-sm text-slate-600">
                <p className="font-medium mb-2">Supported Conversions:</p>
                <ul className="space-y-1">
                  <li>Ã¢â‚¬Â¢ <strong>Excel/CSV:</strong> Auto-maps columns, parses addresses (e.g., "FREEPORT TX"  Ã¢Â†Â’  City, State, Country)</li>
                  <li>Ã¢â‚¬Â¢ <strong>PDF/Image:</strong> {apiKey ? <span className="text-emerald-600">Ã¢Å“â€œ AI extraction enabled</span> : <span className="text-amber-600">Requires API key</span>} - extracts from screenshots, patterns, waybills</li>
                </ul>
              </div>
            </div>
          </div>
        );
      }

      if (step === 'mapping') {
        const needsManual = sourceColumns.some(c => !columnMappings[c] || mappingConfidence[c] < 1);
        const mappedCount = Object.values(columnMappings).filter(v => v).length;
        const skippedCount = sourceColumns.length - mappedCount;
        
        return (
          <div className="max-w-5xl mx-auto">
            <div className="bg-white rounded-xl shadow-lg border overflow-hidden">
              <div className="px-6 py-4 border-b bg-slate-50 flex items-center justify-between">
                <div>
                  <h2 className="text-lg font-bold">Column Mapping</h2>
                  <p className="text-sm text-slate-500">
                    {rawData.length} rows Ã¢â‚¬Â¢ {mappedCount} columns mapped Ã¢â‚¬Â¢ {skippedCount} skipped
                  </p>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => setStep('upload')} className="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">Back</button>
                  <button onClick={processConversion} className="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700">Continue</button>
                </div>
              </div>
              {needsManual && (
                <div className="px-6 py-3 bg-amber-50 border-b flex items-center gap-2">
                  <Icons.AlertTriangle size={16} className="text-amber-600" />
                  <span className="text-sm text-amber-800">Some columns need manual mapping (yellow = unmapped, blue = low confidence)</span>
                </div>
              )}
              <div className="p-6 grid grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto">
                {sourceColumns.map(col => (
                  <div key={col} className={`flex items-center gap-3 p-3 rounded-lg border ${!columnMappings[col] ? 'border-amber-300 bg-amber-50' : mappingConfidence[col] < 1 ? 'border-blue-200 bg-blue-50' : 'border-slate-200'}`}>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium truncate">{col}</p>
                      <p className="text-xs text-slate-400 truncate">{rawData[0]?.[col] || '(empty)'}</p>
                    </div>
                    <Icons.ChevronRight size={16} className="text-slate-400 flex-shrink-0" />
                    <select value={columnMappings[col] || ''} onChange={e => { setColumnMappings({ ...columnMappings, [col]: e.target.value || undefined }); setMappingConfidence({ ...mappingConfidence, [col]: e.target.value ? 1 : 0 }); }}
                      className="flex-1 px-3 py-2 text-sm border rounded-lg">
                      <option value="">-- Skip --</option>
                      {TEMPLATE_COLUMNS.map(tc => <option key={tc} value={tc}>{COLUMN_LABELS[tc]}</option>)}
                    </select>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      // Review step for AI-extracted data
      if (step === 'review') {
        const handleCellEdit = (rowIndex, field, value) => {
          const updated = [...extractedData];
          updated[rowIndex] = { ...updated[rowIndex], [field]: value };
          setExtractedData(updated);
        };

        const proceedToPreview = () => {
          // Generate pattern names if missing
          const processed = extractedData.map(row => {
            const newRow = { ...row };
            if (!newRow.telegraph_pattern_name && newRow.stcc && newRow.origin_city && newRow.destination_city) {
              newRow.telegraph_pattern_name = `${newRow.stcc} - ${newRow.origin_city} - ${newRow.destination_city}`;
            }
            return newRow;
          });
          
          // Validate
          const issues = [];
          processed.forEach((r, i) => {
            if (!r.origin_city) issues.push({ row: i + 1, field: 'Origin City', issue: 'Missing' });
            if (!r.destination_city) issues.push({ row: i + 1, field: 'Dest City', issue: 'Missing' });
          });
          
          setConvertedData(processed);
          setValidationIssues(issues);
          setStep('preview');
        };

        // Group fields for organized display
        const fieldGroups = [
          { name: 'Lane Info', fields: ['telegraph_pattern_name', 'stcc', 'origin_city', 'origin_state', 'origin_country', 'destination_city', 'destination_state', 'destination_country', 'route'] },
          { name: 'Shipment', fields: ['shipment_type', 'bill_type', 'payment_type'] },
          { name: 'Shipper', fields: ['shipper_name', 'shipper_address', 'shipper_city', 'shipper_state', 'shipper_postal', 'shipper_country'] },
          { name: 'Consignee', fields: ['consignee_name', 'consignee_address', 'consignee_city', 'consignee_state', 'consignee_postal', 'consignee_country'] },
          { name: 'Freight Payor', fields: ['freight_payor_name', 'freight_payor_address', 'freight_payor_city', 'freight_payor_state', 'freight_payor_postal', 'freight_payor_country'] },
          { name: 'Rule 11', fields: ['rule11_name', 'rule11_address', 'rule11_city', 'rule11_state', 'rule11_postal', 'rule11_country'] },
          { name: 'Care Of', fields: ['careof_name', 'careof_address', 'careof_city', 'careof_state', 'careof_postal', 'careof_country'] },
        ];

        const filledFieldCount = (row) => TEMPLATE_COLUMNS.filter(f => row[f] && row[f].toString().trim()).length;

        return (
          <div className="max-w-6xl mx-auto">
            <div className="bg-white rounded-xl shadow-lg border overflow-hidden">
              <div className="px-6 py-4 border-b bg-slate-50 flex items-center justify-between">
                <div>
                  <h2 className="text-lg font-bold">Review Extracted Data</h2>
                  <p className="text-sm text-slate-500">{extractedData.length} pattern(s) extracted Ã¢â‚¬Â¢ Click any cell to edit</p>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => setStep('upload')} className="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">Back</button>
                  <button onClick={proceedToPreview} className="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700">Continue to Preview</button>
                </div>
              </div>
              
              <div className="p-4 bg-blue-50 border-b flex items-start gap-3">
                <Icons.Zap size={20} className="text-blue-600 flex-shrink-0 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-blue-800">AI Extraction Complete</p>
                  <p className="text-sm text-blue-700">Review the extracted data below. Click any cell to edit if the AI missed or incorrectly extracted a value.</p>
                </div>
              </div>

              <div className="overflow-x-auto max-h-[60vh]">
                {extractedData.map((row, rowIndex) => (
                  <div key={rowIndex} className="border-b last:border-b-0">
                    <div className="px-4 py-2 bg-slate-100 flex items-center justify-between">
                      <span className="text-sm font-bold text-slate-700">Pattern {rowIndex + 1}</span>
                      <span className="text-xs text-slate-500">{filledFieldCount(row)} / {TEMPLATE_COLUMNS.length} fields populated</span>
                    </div>
                    <div className="p-4 space-y-4">
                      {fieldGroups.map(group => {
                        const hasData = group.fields.some(f => row[f] && row[f].toString().trim());
                        return (
                          <div key={group.name} className={`${hasData ? '' : 'opacity-50'}`}>
                            <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">{group.name}</h4>
                            <div className="grid grid-cols-6 gap-2">
                              {group.fields.map(field => (
                                <div key={field} className="relative">
                                  <label className="text-xs text-slate-400 block mb-1 truncate" title={COLUMN_LABELS[field]}>{COLUMN_LABELS[field]}</label>
                                  <input
                                    type="text"
                                    value={row[field] || ''}
                                    onChange={e => handleCellEdit(rowIndex, field, e.target.value)}
                                    className={`w-full px-2 py-1.5 text-sm border rounded focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 ${row[field] ? 'bg-white border-slate-300' : 'bg-slate-50 border-slate-200'}`}
                                    placeholder="Ã¢â‚¬â€"
                                  />
                                </div>
                              ))}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      if (step === 'preview') {
        const handleAddToProject = (projectId) => {
          if (projectId === 'new') {
            // Will be handled by modal
            return;
          }
          onAddToProject(convertedData, projectId);
          setShowAddToProjectModal(false);
          // Reset for next upload
          setStep('upload');
          setConvertedData([]);
          setRawData([]);
          setExtractedData([]);
        };

        const handleExecuteAnalysis = () => {
          onConvertComplete(convertedData);
        };

        // Calculate field population stats
        const fieldStats = {};
        TEMPLATE_COLUMNS.forEach(col => {
          fieldStats[col] = convertedData.filter(r => r[col] && r[col].toString().trim()).length;
        });
        const populatedFields = Object.entries(fieldStats).filter(([k, v]) => v > 0);
        const emptyFields = Object.entries(fieldStats).filter(([k, v]) => v === 0);

        // Add to Project Modal
        const AddToProjectModal = () => {
          const [newProjectName, setNewProjectName] = useState('');
          const [showNewInput, setShowNewInput] = useState(false);

          const handleCreateAndAdd = () => {
            if (newProjectName.trim()) {
              const newProj = onNewProject(newProjectName.trim());
              onAddToProject(convertedData, newProj.id);
              setShowAddToProjectModal(false);
              setStep('upload');
              setConvertedData([]);
              setRawData([]);
              setExtractedData([]);
            }
          };

          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center">
              <div className="absolute inset-0 bg-black/50" onClick={() => setShowAddToProjectModal(false)} />
              <div className="relative bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
                <div className="px-6 py-5 border-b bg-gradient-to-r from-emerald-600 to-teal-600">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                      <Icons.FolderOpen size={20} className="text-white" />
                    </div>
                    <div>
                      <h2 className="text-lg font-bold text-white">Add to Project</h2>
                      <p className="text-sm text-emerald-100">{convertedData.length} patterns ready to add</p>
                    </div>
                  </div>
                </div>
                <div className="p-6">
                  <p className="text-sm text-slate-600 mb-4">Select a project to add these patterns to, or create a new one. You can then upload more files to the same project.</p>
                  
                  {projects.length > 0 && (
                    <div className="space-y-2 mb-4">
                      {projects.map(p => (
                        <button
                          key={p.id}
                          onClick={() => handleAddToProject(p.id)}
                          className={`w-full text-left px-4 py-3 rounded-lg border hover:border-emerald-400 hover:bg-emerald-50 transition-colors ${currentProject?.id === p.id ? 'border-emerald-400 bg-emerald-50' : 'border-slate-200'}`}
                        >
                          <span className="font-medium text-slate-800">{p.name}</span>
                          <span className="text-sm text-slate-500 ml-2">({p.patterns?.length || 0} patterns)</span>
                          {currentProject?.id === p.id && <span className="text-xs text-emerald-600 ml-2">Ã¢â‚¬Â¢ Current</span>}
                        </button>
                      ))}
                    </div>
                  )}

                  {showNewInput ? (
                    <div className="flex gap-2">
                      <input
                        type="text"
                        value={newProjectName}
                        onChange={e => setNewProjectName(e.target.value)}
                        placeholder="Project name..."
                        className="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:border-emerald-500"
                        autoFocus
                        onKeyDown={e => e.key === 'Enter' && handleCreateAndAdd()}
                      />
                      <button onClick={handleCreateAndAdd} className="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">Create & Add</button>
                    </div>
                  ) : (
                    <button
                      onClick={() => setShowNewInput(true)}
                      className="w-full flex items-center justify-center gap-2 px-4 py-3 border-2 border-dashed border-slate-300 rounded-lg text-slate-600 hover:border-emerald-400 hover:text-emerald-600 hover:bg-emerald-50 transition-colors"
                    >
                      <Icons.Plus size={16} />
                      Create New Project
                    </button>
                  )}
                </div>
                <div className="px-6 py-4 bg-slate-50 border-t flex justify-end">
                  <button onClick={() => setShowAddToProjectModal(false)} className="px-4 py-2 text-sm text-slate-700 hover:bg-slate-200 rounded-lg">Cancel</button>
                </div>
              </div>
            </div>
          );
        };

        return (
          <div className="space-y-6">
            {showAddToProjectModal && <AddToProjectModal />}
            
            <div className="bg-white rounded-xl shadow-lg border overflow-hidden">
              <div className="px-6 py-4 border-b bg-slate-50 flex items-center justify-between">
                <div>
                  <h2 className="text-lg font-bold">Conversion Preview</h2>
                  <p className="text-sm text-slate-500">{convertedData.length} patterns Ã¢â‚¬Â¢ {validationIssues.length} issues</p>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => setStep('upload')} className="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">Back</button>
                  <button onClick={() => exportToCSV(convertedData, 'converted.csv')} className="px-4 py-2 text-sm border rounded-lg hover:bg-slate-50 flex items-center gap-2"><Icons.Download size={14} />CSV</button>
                  <button onClick={() => exportToExcel(convertedData, 'converted.xlsx')} className="px-4 py-2 text-sm border rounded-lg hover:bg-slate-50 flex items-center gap-2"><Icons.Download size={14} />Excel</button>
                </div>
              </div>
              
              {validationIssues.length > 0 && (
                <div className="px-6 py-3 bg-amber-50 border-b">
                  <p className="text-sm font-medium text-amber-800">Issues: {validationIssues.slice(0, 5).map((is, i) => <span key={i} className="ml-2 px-2 py-0.5 bg-amber-100 rounded text-xs">Row {is.row}: {is.field}</span>)}{validationIssues.length > 5 && <span className="ml-2 text-xs">+{validationIssues.length - 5} more</span>}</p>
                </div>
              )}
              
              {/* Field Population Summary */}
              <div className="px-6 py-3 bg-blue-50 border-b">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-blue-800">
                      {populatedFields.length} of {TEMPLATE_COLUMNS.length} fields populated
                    </p>
                    <p className="text-xs text-blue-600 mt-1">
                      {populatedFields.slice(0, 8).map(([k]) => COLUMN_LABELS[k] || k).join(', ')}
                      {populatedFields.length > 8 && ` +${populatedFields.length - 8} more`}
                    </p>
                  </div>
                  {emptyFields.length > 0 && emptyFields.length < 20 && (
                    <details className="text-xs">
                      <summary className="text-blue-600 cursor-pointer hover:text-blue-800">Show empty fields</summary>
                      <div className="mt-2 p-2 bg-white rounded border text-slate-600 max-w-md">
                        {emptyFields.map(([k]) => COLUMN_LABELS[k] || k).join(', ')}
                      </div>
                    </details>
                  )}
                </div>
              </div>
              
              <div className="overflow-x-auto max-h-[40vh]">
                <table className="w-full text-sm">
                  <thead className="bg-slate-100 sticky top-0">
                    <tr>{['Pattern Name', 'STCC', 'Origin', 'Destination', 'Route', 'Payment', 'Shipper', 'Shipper Addr', 'Consignee', 'Consignee Addr', 'Freight Payor'].map(h => <th key={h} className="text-left px-3 py-2 font-semibold whitespace-nowrap">{h}</th>)}</tr>
                  </thead>
                  <tbody className="divide-y">
                    {convertedData.slice(0, 50).map((r, i) => (
                      <tr key={i} className="hover:bg-slate-50">
                        <td className="px-3 py-2 font-medium max-w-[200px] truncate">{r.telegraph_pattern_name || 'Ã¢â‚¬â€'}</td>
                        <td className="px-3 py-2">{r.stcc || 'Ã¢â‚¬â€'}</td>
                        <td className="px-3 py-2 whitespace-nowrap">{[r.origin_city, r.origin_state].filter(Boolean).join(', ') || 'Ã¢â‚¬â€'}</td>
                        <td className="px-3 py-2 whitespace-nowrap">{[r.destination_city, r.destination_state].filter(Boolean).join(', ') || 'Ã¢â‚¬â€'}</td>
                        <td className="px-3 py-2">{r.route || 'Ã¢â‚¬â€'}</td>
                        <td className="px-3 py-2">{r.payment_type || 'Ã¢â‚¬â€'}</td>
                        <td className="px-3 py-2 max-w-[150px] truncate">{r.shipper_name || 'Ã¢â‚¬â€'}</td>
                        <td className="px-3 py-2 max-w-[150px] truncate">{r.shipper_address || 'Ã¢â‚¬â€'}</td>
                        <td className="px-3 py-2 max-w-[150px] truncate">{r.consignee_name || 'Ã¢â‚¬â€'}</td>
                        <td className="px-3 py-2 max-w-[150px] truncate">{r.consignee_address || 'Ã¢â‚¬â€'}</td>
                        <td className="px-3 py-2 max-w-[150px] truncate">{r.freight_payor_name || 'Ã¢â‚¬â€'}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                {convertedData.length > 0 && (
                  <div className="p-3 bg-slate-50 border-t text-xs text-slate-500">
                    Showing preview columns. Export to CSV/Excel to see all {TEMPLATE_COLUMNS.length} fields.
                  </div>
                )}
              </div>
              
              {/* Action Buttons */}
              <div className="px-6 py-4 bg-slate-50 border-t">
                <div className="flex items-center justify-between">
                  <div className="text-sm text-slate-600">
                    {currentProject ? (
                      <span>Current project: <strong>{currentProject.name}</strong> ({currentProject.patterns?.length || 0} existing patterns)</span>
                    ) : (
                      <span className="text-slate-400">No project selected</span>
                    )}
                  </div>
                  <div className="flex gap-3">
                    <button 
                      onClick={() => setShowAddToProjectModal(true)} 
                      className="px-4 py-2 bg-emerald-600 text-white text-sm font-medium rounded-lg hover:bg-emerald-700 flex items-center gap-2"
                    >
                      <Icons.Plus size={16} />
                      Add to Project
                    </button>
                    <button 
                      onClick={handleExecuteAnalysis} 
                      className="px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-sm font-medium rounded-lg hover:from-blue-700 hover:to-indigo-700 flex items-center gap-2"
                    >
                      <Icons.Play size={14} />
                      Execute Analysis
                    </button>
                  </div>
                </div>
                <p className="text-xs text-slate-500 mt-2">
                  <strong>Add to Project:</strong> Save patterns and upload more files Ã¢â‚¬Â¢ <strong>Execute Analysis:</strong> Go to analysis with {currentProject ? 'all project patterns' : 'just these patterns'}
                </p>
              </div>
            </div>
          </div>
        );
      }
    };

    // Main App
    function App() {
      const [activeNav, setActiveNav] = useState('analysis');
      const [selectedCompany, setSelectedCompany] = useState('[CP] Acme Inc.');
      const [bookingExpanded, setBookingExpanded] = useState(true);
      const [projects, setProjects] = useState(() => loadProjects());
      const [currentProject, setCurrentProject] = useState(null);
      const [standaloneData, setStandaloneData] = useState([]);
      const [builtPatterns, setBuiltPatterns] = useState(() => {
        try { return JSON.parse(localStorage.getItem('telegraph_built_patterns')) || []; } catch { return []; }
      });
      const [toast, setToast] = useState(null);

      // Auto-hide toast after 5 seconds
      useEffect(() => {
        if (toast) {
          const timer = setTimeout(() => setToast(null), 5000);
          return () => clearTimeout(timer);
        }
      }, [toast]);

      // Save built patterns to localStorage
      useEffect(() => {
        localStorage.setItem('telegraph_built_patterns', JSON.stringify(builtPatterns));
      }, [builtPatterns]);

      const showToast = (message, type = 'success') => {
        setToast({ message, type });
      };

      useEffect(() => { saveProjects(projects); }, [projects]);

      const currentData = currentProject ? (currentProject.patterns || []) : standaloneData;

      const handleNewProject = (name) => {
        const p = { id: Date.now().toString(), name, patterns: [], createdAt: new Date().toISOString() };
        setProjects([...projects, p]);
        setCurrentProject(p);
        return p; // Return the new project for immediate use
      };

      const handleDeleteProject = (id) => {
        setProjects(projects.filter(p => p.id !== id));
        if (currentProject?.id === id) setCurrentProject(null);
      };

      const updateProjectPatterns = (patterns) => {
        if (currentProject) {
          const updated = projects.map(p => p.id === currentProject.id ? { ...p, patterns } : p);
          setProjects(updated);
          setCurrentProject({ ...currentProject, patterns });
        }
      };

      const handleAddToProject = (newPatterns, projectId) => {
        // Find the target project
        const targetProject = projects.find(p => p.id === projectId);
        if (targetProject) {
          const combined = [...(targetProject.patterns || []), ...newPatterns];
          const updated = projects.map(p => p.id === projectId ? { ...p, patterns: combined } : p);
          setProjects(updated);
          // If this is the current project, update it too
          if (currentProject?.id === projectId) {
            setCurrentProject({ ...targetProject, patterns: combined });
          } else {
            // Switch to the project we just added to
            setCurrentProject({ ...targetProject, patterns: combined });
          }
        }
      };

      const handleConvertComplete = (data) => {
        if (currentProject) {
          // If there's a current project, replace its data with the new data for analysis
          // But the user might want to analyze just the converted data or all project data
          // Let's analyze all project data + new data
          const allData = [...(currentProject.patterns || []), ...data];
          updateProjectPatterns(allData);
          setStandaloneData(allData);
        } else {
          setStandaloneData(data);
        }
        setActiveNav('analysis');
      };

      const handleClearData = () => {
        if (currentProject) { updateProjectPatterns([]); }
        else { setStandaloneData([]); }
      };

      const PageIcon = activeNav === 'analysis' ? Icons.BarChart3 : activeNav === 'converter' ? Icons.ArrowRightLeft : Icons.Layers;
      const pageTitle = activeNav === 'analysis' ? 'Pattern Analysis' : activeNav === 'converter' ? 'Pattern Converter' : 'Patterns';

      return (
        <div className="min-h-screen bg-gray-100">
          {/* Toast Notification */}
          {toast && (
            <div className="fixed top-4 right-4 z-[100] animate-slide-in">
              <div className={`flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg border ${
                toast.type === 'success' ? 'bg-emerald-50 border-emerald-200 text-emerald-800' :
                toast.type === 'error' ? 'bg-red-50 border-red-200 text-red-800' :
                'bg-blue-50 border-blue-200 text-blue-800'
              }`}>
                {toast.type === 'success' && <Icons.Check size={20} className="text-emerald-600" />}
                {toast.type === 'error' && <Icons.AlertCircle size={20} className="text-red-600" />}
                <span className="text-sm font-medium">{toast.message}</span>
                <button onClick={() => setToast(null)} className="ml-2 text-current opacity-50 hover:opacity-100">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M18 6L6 18M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>
          )}
          <Sidebar activeNav={activeNav} setActiveNav={setActiveNav} selectedCompany={selectedCompany} setSelectedCompany={setSelectedCompany} bookingExpanded={bookingExpanded} setBookingExpanded={setBookingExpanded} />
          <main className="ml-64 min-h-screen">
            <header className="sticky top-0 z-40 bg-white border-b px-6 py-4 flex items-center justify-between shadow-sm">
              <div className="flex items-center gap-3">
                <PageIcon size={24} className="text-blue-600" />
                <div><h1 className="text-xl font-bold text-slate-800">{pageTitle}</h1><p className="text-xs text-slate-500">{selectedCompany}</p></div>
              </div>
              <div className="flex items-center gap-4">
                <ProjectSelector projects={projects} currentProject={currentProject} setCurrentProject={setCurrentProject} onNewProject={handleNewProject} onDeleteProject={handleDeleteProject} />
                {activeNav === 'analysis' && currentData.length > 0 && <button onClick={handleClearData} className="px-3 py-1.5 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">Clear Data</button>}
              </div>
            </header>
            <div className="p-6">
              {activeNav === 'analysis' && <PatternAnalysis data={currentData} onClear={handleClearData} onBuildPatterns={(patterns) => { setBuiltPatterns(prev => [...prev, ...patterns]); setActiveNav('patterns'); showToast(`Successfully built ${patterns.length} pattern${patterns.length !== 1 ? 's' : ''}!`); }} />}
              {activeNav === 'converter' && <PatternConverter onConvertComplete={handleConvertComplete} onAddToProject={handleAddToProject} currentProject={currentProject} projects={projects} setCurrentProject={setCurrentProject} onNewProject={handleNewProject} />}
              {activeNav === 'patterns' && <PatternsPage patterns={builtPatterns} onCreatePattern={() => setActiveNav('converter')} onDeleteAllPatterns={() => { setBuiltPatterns([]); }} />}
            </div>
          </main>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
